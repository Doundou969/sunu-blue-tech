#!/bin/bash
# ============================================================================
# PECHEURCONNECT v2.1 - DAEMON MODE
# ============================================================================
# Lance le bot Telegram en arrière-plan avec collecte automatique des données
# ============================================================================

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# Fichiers de log
LOG_DIR="logs"
BOT_LOG="$LOG_DIR/bot.log"
COLLECTOR_LOG="$LOG_DIR/collector.log"
PID_FILE="$LOG_DIR/pecheurconnect.pid"

# Créer le dossier logs
mkdir -p "$LOG_DIR"

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Fonctions
log() {
    echo -e "${GREEN}[PecheurConnect]${NC} $1"
}

error() {
    echo -e "${RED}[ERREUR]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[ATTENTION]${NC} $1"
}

# ============================================================================
# COMMANDES
# ============================================================================

start_services() {
    log "Démarrage de PecheurConnect v2.1..."
    
    # Vérifier si déjà lancé
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p $PID > /dev/null 2>&1; then
            warning "PecheurConnect est déjà en cours d'exécution (PID: $PID)"
            exit 1
        else
            rm "$PID_FILE"
        fi
    fi
    
    # Charger l'environnement
    if [ -f .env ]; then
        export $(cat .env | grep -v '^#' | xargs)
    else
        error "Fichier .env non trouvé"
        exit 1
    fi
    
    # Collecte initiale des données
    log "Collecte initiale des données..."
    python3 script_peche_complet.py > "$COLLECTOR_LOG" 2>&1
    
    if [ $? -eq 0 ]; then
        log "✓ Données collectées"
    else
        error "Échec de la collecte initiale"
        exit 1
    fi
    
    # Lancer le bot Telegram en arrière-plan
    if [ -n "$TELEGRAM_BOT_TOKEN" ]; then
        log "Démarrage du bot Telegram..."
        nohup python3 bot_telegram.py > "$BOT_LOG" 2>&1 &
        BOT_PID=$!
        
        # Sauvegarder le PID
        echo $BOT_PID > "$PID_FILE"
        
        sleep 2
        
        if ps -p $BOT_PID > /dev/null; then
            log "✓ Bot Telegram démarré (PID: $BOT_PID)"
        else
            error "Échec du démarrage du bot"
            rm "$PID_FILE"
            exit 1
        fi
    else
        warning "TELEGRAM_BOT_TOKEN non configuré - bot non lancé"
    fi
    
    # Configurer la collecte automatique (cron)
    setup_auto_collection
    
    log "✓ PecheurConnect démarré avec succès!"
    log ""
    log "Logs disponibles:"
    log "  Bot: tail -f $BOT_LOG"
    log "  Collecte: tail -f $COLLECTOR_LOG"
    log ""
    log "Commandes:"
    log "  ./daemon.sh status  - Vérifier le statut"
    log "  ./daemon.sh stop    - Arrêter"
    log "  ./daemon.sh restart - Redémarrer"
}

stop_services() {
    log "Arrêt de PecheurConnect..."
    
    if [ ! -f "$PID_FILE" ]; then
        warning "PecheurConnect n'est pas en cours d'exécution"
        exit 1
    fi
    
    PID=$(cat "$PID_FILE")
    
    if ps -p $PID > /dev/null 2>&1; then
        kill $PID
        sleep 2
        
        if ps -p $PID > /dev/null 2>&1; then
            warning "Arrêt forcé..."
            kill -9 $PID
        fi
        
        rm "$PID_FILE"
        log "✓ PecheurConnect arrêté"
    else
        warning "Processus $PID non trouvé"
        rm "$PID_FILE"
    fi
}

status_services() {
    echo ""
    echo "========================================="
    echo "STATUT PECHEURCONNECT v2.1"
    echo "========================================="
    echo ""
    
    # Vérifier le bot
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p $PID > /dev/null 2>&1; then
            log "✓ Bot Telegram: EN COURS (PID: $PID)"
            
            # Temps de fonctionnement
            UPTIME=$(ps -p $PID -o etime= | tr -d ' ')
            echo "  Temps de fonctionnement: $UPTIME"
        else
            error "✗ Bot Telegram: ARRÊTÉ (PID obsolète: $PID)"
        fi
    else
        warning "✗ Bot Telegram: NON LANCÉ"
    fi
    
    echo ""
    
    # Vérifier data.json
    if [ -f "data.json" ]; then
        LAST_UPDATE=$(stat -f "%Sm" -t "%Y-%m-%d %H:%M:%S" data.json 2>/dev/null || stat -c "%y" data.json 2>/dev/null | cut -d. -f1)
        log "✓ Données: DISPONIBLES"
        echo "  Dernière mise à jour: $LAST_UPDATE"
    else
        warning "✗ Données: NON DISPONIBLES"
    fi
    
    echo ""
    
    # Vérifier les logs
    if [ -f "$BOT_LOG" ]; then
        LINES=$(wc -l < "$BOT_LOG")
        echo "Logs bot: $LINES lignes ($BOT_LOG)"
    fi
    
    if [ -f "$COLLECTOR_LOG" ]; then
        LINES=$(wc -l < "$COLLECTOR_LOG")
        echo "Logs collecte: $LINES lignes ($COLLECTOR_LOG)"
    fi
    
    echo ""
    echo "========================================="
    echo ""
}

restart_services() {
    log "Redémarrage de PecheurConnect..."
    stop_services
    sleep 2
    start_services
}

setup_auto_collection() {
    log "Configuration de la collecte automatique..."
    
    # Vérifier si cron est disponible
    if ! command -v crontab &> /dev/null; then
        warning "cron n'est pas installé - collecte automatique non configurée"
        return
    fi
    
    # Créer une tâche cron pour collecter toutes les 6 heures
    CRON_CMD="0 */6 * * * cd $SCRIPT_DIR && python3 script_peche_complet.py >> $COLLECTOR_LOG 2>&1"
    
    # Vérifier si la tâche existe déjà
    (crontab -l 2>/dev/null | grep -v "script_peche_complet.py" ; echo "$CRON_CMD") | crontab -
    
    log "✓ Collecte automatique configurée (toutes les 6 heures)"
}

view_logs() {
    echo ""
    echo "========================================="
    echo "LOGS PECHEURCONNECT"
    echo "========================================="
    echo ""
    echo "1. Logs du bot (temps réel)"
    echo "2. Logs de collecte (temps réel)"
    echo "3. Dernières 50 lignes - bot"
    echo "4. Dernières 50 lignes - collecte"
    echo "5. Retour"
    echo ""
    read -p "Choisissez une option: " choice
    
    case $choice in
        1)
            tail -f "$BOT_LOG"
            ;;
        2)
            tail -f "$COLLECTOR_LOG"
            ;;
        3)
            tail -n 50 "$BOT_LOG"
            ;;
        4)
            tail -n 50 "$COLLECTOR_LOG"
            ;;
        5)
            return
            ;;
        *)
            error "Option invalide"
            ;;
    esac
}

collect_now() {
    log "Collecte manuelle des données..."
    python3 script_peche_complet.py
    
    if [ $? -eq 0 ]; then
        log "✓ Collecte terminée"
    else
        error "Échec de la collecte"
    fi
}

# ============================================================================
# MENU PRINCIPAL
# ============================================================================

case "$1" in
    start)
        start_services
        ;;
    stop)
        stop_services
        ;;
    restart)
        restart_services
        ;;
    status)
        status_services
        ;;
    logs)
        view_logs
        ;;
    collect)
        collect_now
        ;;
    *)
        echo ""
        echo "PecheurConnect v2.1 - Gestionnaire de services"
        echo ""
        echo "Usage: $0 {start|stop|restart|status|logs|collect}"
        echo ""
        echo "Commandes:"
        echo "  start   - Démarrer tous les services"
        echo "  stop    - Arrêter tous les services"
        echo "  restart - Redémarrer tous les services"
        echo "  status  - Afficher le statut"
        echo "  logs    - Consulter les logs"
        echo "  collect - Collecter les données maintenant"
        echo ""
        exit 1
        ;;
esac

exit 0
