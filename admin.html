<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0056b3">
    <title>Dashboard Admin - PecheurConnect v3.0 üá∏üá≥</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #0056b3;
            --safe: #00c853;
            --caution: #ffd600;
            --warning: #ff6d00;
            --danger: #d50000;
            --bg: #f5f7fa;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
        }
        
        /* HEADER */
        .header {
            background: white;
            padding: 24px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            font-family: 'Syne', sans-serif;
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .header-left p {
            font-size: 13px;
            color: #888;
        }
        
        .header-time {
            font-size: 14px;
            color: #666;
            font-family: monospace;
        }
        
        /* CONTAINER */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }
        
        /* KPIs */
        .kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }
        
        .kpi-card.safe::before { background: var(--safe); }
        .kpi-card.warning::before { background: var(--warning); }
        .kpi-card.danger::before { background: var(--danger); }
        
        .kpi-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            margin-bottom: 10px;
        }
        
        .kpi-value {
            font-family: 'Syne', sans-serif;
            font-size: 36px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 6px;
        }
        
        .kpi-trend {
            font-size: 13px;
            color: #666;
        }
        
        /* CHARTS */
        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        }
        
        .chart-card h3 {
            font-family: 'Syne', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        /* TABLE */
        .table-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            overflow-x: auto;
        }
        
        .table-card h3 {
            font-family: 'Syne', sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
            border-bottom: 2px solid #e0e0e0;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        
        tr:hover {
            background: #fafbff;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }
        
        .badge-safe { background: #e8f5e9; color: #2e7d32; }
        .badge-caution { background: #fff8e1; color: #f57f17; }
        .badge-warning { background: #fff3e0; color: #e65100; }
        .badge-danger { background: #ffebee; color: #b71c1c; }
        
        /* LOADING */
        .loading {
            text-align: center;
            padding: 80px;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f0f0f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 1024px) {
            .charts { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .container { padding: 16px; }
            .header { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-left">
        <h1>üèõÔ∏è Dashboard National - P√™che Maritime</h1>
        <p>Minist√®re de la P√™che et de l'√âconomie Maritime - S√©n√©gal üá∏üá≥</p>
    </div>
    <div class="header-time" id="currentTime"></div>
</div>

<div class="container">
    
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p style="color:#888;">Chargement des donn√©es nationales...</p>
    </div>
    
    <div id="content" style="display:none;">
        
        <!-- KPIs -->
        <div class="kpis">
            <div class="kpi-card">
                <div class="kpi-title">Zones Actives</div>
                <div class="kpi-value" id="totalZones">18</div>
                <div class="kpi-trend">100% op√©rationnel</div>
            </div>
            
            <div class="kpi-card safe">
                <div class="kpi-title">Zones S√ªres</div>
                <div class="kpi-value" id="safeZones">0</div>
                <div class="kpi-trend" id="safeTrend">Chargement...</div>
            </div>
            
            <div class="kpi-card danger">
                <div class="kpi-title">Alertes Actives</div>
                <div class="kpi-value" id="alerts">0</div>
                <div class="kpi-trend" id="alertTrend">Zones en danger/prudence</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-title">Pr√©vision 24h</div>
                <div class="kpi-value">‚úÖ</div>
                <div class="kpi-trend">Conditions stables attendues</div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="charts">
            <div class="chart-card">
                <h3>üìä R√©partition S√©curit√©</h3>
                <canvas id="safetyChart"></canvas>
            </div>
            
            <div class="chart-card">
                <h3>üìà Conditions Moyennes par R√©gion</h3>
                <canvas id="regionChart"></canvas>
            </div>
        </div>
        
        <!-- Table -->
        <div class="table-card">
            <h3>üó∫Ô∏è √âtat D√©taill√© des Zones</h3>
            <table>
                <thead>
                    <tr>
                        <th>Zone</th>
                        <th>R√©gion</th>
                        <th>Vagues</th>
                        <th>Temp√©rature</th>
                        <th>Vent</th>
                        <th>S√©curit√©</th>
                        <th>P√™che</th>
                        <th>MAJ</th>
                    </tr>
                </thead>
                <tbody id="zonesTableBody"></tbody>
            </table>
        </div>
        
    </div>
</div>

<script>
let allZones = [];

async function init() {
    updateTime();
    setInterval(updateTime, 1000);
    
    try {
        const response = await fetch('./data.json?v=' + Date.now());
        allZones = await response.json();
        
        updateKPIs();
        createCharts();
        fillTable();
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        
        // Auto-refresh 5 min
        setInterval(async () => {
            const res = await fetch('./data.json?v=' + Date.now());
            allZones = await res.json();
            updateKPIs();
            fillTable();
        }, 5 * 60 * 1000);
        
    } catch (error) {
        console.error('Erreur:', error);
        document.getElementById('loading').innerHTML = '<p style="color:#d32f2f;">‚ùå Erreur chargement</p>';
    }
}

function updateTime() {
    const now = new Date();
    document.getElementById('currentTime').textContent = now.toLocaleString('fr-FR', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}

function updateKPIs() {
    const safe = allZones.filter(z => z.safety_level === 'safe').length;
    const danger = allZones.filter(z => z.safety_level === 'danger' || z.safety_level === 'warning').length;
    
    document.getElementById('totalZones').textContent = allZones.length;
    document.getElementById('safeZones').textContent = safe;
    document.getElementById('safeTrend').textContent = `${Math.round(safe / allZones.length * 100)}% des zones`;
    document.getElementById('alerts').textContent = danger;
    document.getElementById('alertTrend').textContent = danger === 0 ? 'Aucune alerte' : `${danger} zone(s) √† surveiller`;
}

function createCharts() {
    const safetyCounts = {
        safe: allZones.filter(z => z.safety_level === 'safe').length,
        caution: allZones.filter(z => z.safety_level === 'caution').length,
        warning: allZones.filter(z => z.safety_level === 'warning').length,
        danger: allZones.filter(z => z.safety_level === 'danger').length
    };
    
    new Chart(document.getElementById('safetyChart'), {
        type: 'doughnut',
        data: {
            labels: ['S√ªr', 'Vigilance', 'Prudence', 'Danger'],
            datasets: [{
                data: [safetyCounts.safe, safetyCounts.caution, safetyCounts.warning, safetyCounts.danger],
                backgroundColor: ['#00c853', '#ffd600', '#ff6d00', '#d50000'],
                borderWidth: 3,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
    
    const regions = {};
    allZones.forEach(z => {
        if (!regions[z.region]) {
            regions[z.region] = { wave: 0, temp: 0, count: 0 };
        }
        regions[z.region].wave += z.v_now;
        regions[z.region].temp += z.t_now;
        regions[z.region].count++;
    });
    
    const regionNames = Object.keys(regions);
    const avgWaves = regionNames.map(r => (regions[r].wave / regions[r].count).toFixed(2));
    
    new Chart(document.getElementById('regionChart'), {
        type: 'bar',
        data: {
            labels: regionNames,
            datasets: [{
                label: 'Vagues moy. (m)',
                data: avgWaves,
                backgroundColor: '#0056b3'
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

function fillTable() {
    const tbody = document.getElementById('zonesTableBody');
    tbody.innerHTML = '';
    
    allZones.forEach(zone => {
        const safetyClass = {
            safe: 'badge-safe',
            caution: 'badge-caution',
            warning: 'badge-warning',
            danger: 'badge-danger'
        }[zone.safety_level] || '';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${zone.zone}</strong></td>
            <td>${zone.region}</td>
            <td>${zone.v_now}m</td>
            <td>${zone.t_now}¬∞C</td>
            <td>${zone.wind_speed || 'N/A'}m/s</td>
            <td><span class="badge ${safetyClass}">${zone.safety_level.toUpperCase()}</span></td>
            <td>${zone.fish_level}</td>
            <td>${zone.date} UTC</td>
        `;
        tbody.appendChild(row);
    });
}

init();
</script>

</body>
</html>
