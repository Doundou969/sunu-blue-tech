<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0056b3">
    <title>Historique - PecheurConnect v3.0 üá∏üá≥</title>

    <link rel="manifest" href="./manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* ============================================================
            VARIABLES & RESET (Inchang√©)
        ============================================================ */
        :root {
            --primary:    #0056b3;
            --primary-dk: #003d7a;
            --accent:      #00c8ff;
            --safe:        #00c853;
            --caution:    #ffd600;
            --warning:    #ff6d00;
            --danger:      #d50000;
            --dark:        #0a1628;
            --bg:          #f0f4f8;
            --card:        #ffffff;
            --radius:      14px;
            --shadow:      0 4px 24px rgba(0,0,0,0.10);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); min-height: 100vh; color: #333; }

        /* ============================================================
            LAYOUT & TOPBAR
        ============================================================ */
        .topbar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dk) 100%);
            padding: 0 30px;
            box-shadow: 0 4px 20px rgba(0,86,179,0.3);
            position: sticky; top: 0; z-index: 100;
        }
        .topbar-inner {
            max-width: 1400px; margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between; height: 64px;
        }
        .topbar-brand {
            font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800;
            color: white; text-decoration: none;
        }
        .topbar-nav { display: flex; gap: 4px; }
        .topbar-nav a {
            color: rgba(255,255,255,0.75); text-decoration: none; font-size: 13px;
            padding: 6px 14px; border-radius: 20px; transition: 0.2s;
        }
        .topbar-nav a.active, .topbar-nav a:hover { background: rgba(255,255,255,0.2); color: white; }

        .page { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }

        /* ============================================================
            HEADER & BUTTONS
        ============================================================ */
        .page-header {
            background: white; border-radius: var(--radius); padding: 25px;
            box-shadow: var(--shadow); margin-bottom: 24px;
            display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;
        }
        .page-header h1 { font-family: 'Syne', sans-serif; font-size: 28px; color: var(--primary); }
        .btn {
            display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px;
            border-radius: 25px; font-weight: 600; cursor: pointer; text-decoration: none; border: none;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost { background: #f0f4f8; color: var(--primary); border: 2px solid #e0e8f0; }

        /* ============================================================
            ZONE SELECTOR
        ============================================================ */
        .zone-selector-card { background: white; border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); margin-bottom: 24px; }
        .region-tabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
        .region-tab { padding: 6px 14px; background: #f0f4f8; border-radius: 20px; font-size: 12px; cursor: pointer; font-weight: 600; }
        .region-tab.active { background: var(--primary); color: white; }
        .zone-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px; }
        .zone-btn {
            padding: 12px; background: #f8f9fa; border: 2px solid #e8ecf0; border-radius: 10px;
            cursor: pointer; text-align: center; font-weight: 600; font-size: 12px;
        }
        .zone-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* ============================================================
            STAT CARDS
        ============================================================ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--primary); }
        .stat-value { font-family: 'Syne', sans-serif; font-size: 32px; font-weight: 800; color: var(--primary); margin: 10px 0; }
        .trend-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .trend-badge.hausse { background: #fff0f0; color: var(--danger); }
        .trend-badge.baisse { background: #f0fff4; color: var(--safe); }
        .trend-badge.stable { background: #f0f7ff; color: var(--primary); }

        /* ============================================================
            COPERNICUS SEASONALITY (Nouveau)
        ============================================================ */
        .seasonality-card {
            background: white; border-radius: var(--radius); padding: 24px;
            box-shadow: var(--shadow); margin-bottom: 24px; border-top: 5px solid var(--accent);
        }
        .seasonality-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .seasonality-header h3 { font-family: 'Syne', sans-serif; color: var(--primary); font-size: 18px; }
        #fishing-advice { background: #f0f7ff; padding: 15px; border-radius: 10px; border-left: 4px solid var(--accent); font-size: 14px; }
        .seasonality-container { position: relative; height: 300px; width: 100%; }

        /* ============================================================
            CHARTS & TABLES
        ============================================================ */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .chart-card { background: white; border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); }
        .history-table-card { background: white; border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead th { background: #f8f9fa; padding: 12px; text-align: left; color: #888; border-bottom: 2px solid #eee; }
        tbody td { padding: 12px; border-bottom: 1px solid #f5f5f5; }
        
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
        .badge-safe { background: #e8f5e9; color: #2e7d32; }
        .badge-danger { background: #ffebee; color: #b71c1c; }

        /* States */
        .state-box { background: white; border-radius: var(--radius); padding: 60px; text-align: center; box-shadow: var(--shadow); }
        .spinner-ring { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) { .charts-grid { grid-template-columns: 1fr; } .topbar-nav { display: none; } }
    </style>
</head>
<body>

<div class="topbar">
    <div class="topbar-inner">
        <a href="./index.html" class="topbar-brand">üåä PecheurConnect</a>
        <nav class="topbar-nav">
            <a href="./index.html">üó∫Ô∏è Carte</a>
            <a href="./history.html" class="active">üìä Historique</a>
            <a href="./comparator.html">üéØ Comparer</a>
            <a href="./alerts-settings.html">üîî Alertes</a>
        </nav>
    </div>
</div>

<div class="page">
    <div class="page-header">
        <div>
            <h1>üìä Historique & Tendances</h1>
            <p>Donn√©es temps r√©el connect√©es √† <strong>Copernicus Marine</strong> üõ∞Ô∏è</p>
        </div>
        <div class="header-actions">
            <a href="./export.html" class="btn btn-ghost">üìÑ Exporter</a>
            <a href="./index.html" class="btn btn-primary">üó∫Ô∏è Carte</a>
        </div>
    </div>

    <div class="zone-selector-card">
        <div class="region-tabs">
            <div class="region-tab active" onclick="filterRegionZones(this, 'all')">Toutes</div>
            <div class="region-tab" onclick="filterRegionZones(this, 'Nord')">Nord</div>
            <div class="region-tab" onclick="filterRegionZones(this, 'Dakar')">Dakar</div>
            <div class="region-tab" onclick="filterRegionZones(this, 'Petite C√¥te')">Petite C√¥te</div>
            <div class="region-tab" onclick="filterRegionZones(this, 'Casamance')">Casamance</div>
        </div>
        <div class="zone-grid" id="zoneGrid"></div>
    </div>

    <div id="stateLoading" class="state-box"><div class="spinner-ring"></div>Chargement des donn√©es...</div>
    <div id="stateEmpty" class="state-box" style="display:none;">Aucune donn√©e disponible pour le moment.</div>

    <div id="content" style="display:none;">
        
        <div class="seasonality-card">
            <div class="seasonality-header">
                <h3><i class="fas fa-calendar-check"></i> Calendrier de P√™che Copernicus (Moyennes 10 ans)</h3>
                <span class="badge badge-safe">Scientifiquement Valid√©</span>
            </div>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 2; min-width: 300px;">
                    <div class="seasonality-container"><canvas id="seasonalityChart"></canvas></div>
                </div>
                <div style="flex: 1; min-width: 250px;">
                    <div id="fishing-advice">
                        <strong>üí° Analyse Saisonni√®re :</strong>
                        <p id="advice-text" style="margin-top: 10px;">Analyse en cours...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid"></div>

        <div class="charts-grid">
            <div class="chart-card"><h4>üåä Vagues (7j)</h4><canvas id="waveChart"></canvas></div>
            <div class="chart-card"><h4>üå°Ô∏è Temp√©rature Eau</h4><canvas id="tempChart"></canvas></div>
        </div>

        <div class="history-table-card">
            <h3>üìã Derniers relev√©s</h3>
            <table>
                <thead>
                    <tr><th>Date</th><th>Heure</th><th>Vagues</th><th>Temp.</th><th>Vent</th><th>S√©curit√©</th></tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let allStats = {};
    let seasonalityData = {};
    let activeCharts = {};

    const ZONE_REGIONS = {
        "SAINT-LOUIS": "Nord", "KAYAR": "Nord", "DAKAR-YOFF": "Dakar", "DAKAR-HANN": "Dakar",
        "MBOUR-JOAL": "Petite C√¥te", "SALY": "Petite C√¥te", "CASAMANCE-ZIGUINCHOR": "Casamance"
    };

    document.addEventListener('DOMContentLoaded', init);

    async function init() {
        try {
            // Chargement simultan√© des deux sources de donn√©es
            const [statsRes, seasonRes] = await Promise.all([
                fetch('./logs/stats/all_zones.json'),
                fetch('seasonality_data.json')
            ]);

            allStats = await statsRes.json();
            seasonalityData = await seasonRes.json();

            buildZoneButtons(Object.keys(allStats));
            selectZone(Object.keys(allStats)[0]);
            
            document.getElementById('stateLoading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        } catch (e) {
            document.getElementById('stateLoading').style.display = 'none';
            document.getElementById('stateEmpty').style.display = 'block';
        }
    }

    function buildZoneButtons(zones) {
        const grid = document.getElementById('zoneGrid');
        zones.forEach(name => {
            const btn = document.createElement('div');
            btn.className = 'zone-btn';
            btn.innerText = name;
            btn.onclick = () => selectZone(name);
            btn.dataset.region = ZONE_REGIONS[name] || 'Dakar';
            grid.appendChild(btn);
        });
    }

    function selectZone(name) {
        document.querySelectorAll('.zone-btn').forEach(b => b.classList.toggle('active', b.innerText === name));
        const data = allStats[name];
        renderStats(data);
        renderCharts(data);
        renderTable(data);
        renderSeasonality(name);
    }

    function renderStats(data) {
        const s = data.statistics;
        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card">
                <div style="color:#888; font-size:11px">VAGUES MOY.</div>
                <div class="stat-value">${s.waves.avg}m</div>
                <div class="trend-badge ${s.waves.trend}">${s.waves.trend}</div>
            </div>
            <div class="stat-card">
                <div style="color:#888; font-size:11px">TEMP√âRATURE</div>
                <div class="stat-value">${s.temperature.avg}¬∞C</div>
                <div class="trend-badge ${s.temperature.trend}">${s.temperature.trend}</div>
            </div>
            <div class="stat-card">
                <div style="color:#888; font-size:11px">VENT</div>
                <div class="stat-value">${s.wind.avg}m/s</div>
                <div class="trend-badge ${s.wind.trend}">${s.wind.trend}</div>
            </div>
        `;
    }

    function renderSeasonality(zoneName) {
        const key = Object.keys(seasonalityData).find(k => zoneName.includes(k.toUpperCase())) || "Dakar";
        const points = seasonalityData[key];
        const ctx = document.getElementById('seasonalityChart').getContext('2d');

        if (activeCharts.season) activeCharts.season.destroy();
        activeCharts.season = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan','F√©v','Mar','Avr','Mai','Jui','Jul','Ao√ª','Sep','Oct','Nov','D√©c'],
                datasets: [{
                    label: 'Potentiel de P√™che %',
                    data: points,
                    borderColor: '#00c8ff',
                    fill: true,
                    backgroundColor: 'rgba(0,200,255,0.1)',
                    tension: 0.4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const month = new Date().getMonth();
        const val = points[month];
        document.getElementById('advice-text').innerText = `Indice de ${val}% pour ce mois. ${val > 75 ? 'P√©riode d\'Upwelling intense : la p√™che est optimale.' : 'Eaux plus chaudes : les poissons sont plus rares en surface.'}`;
    }

    function renderCharts(data) {
        const history = data.history.slice(-48);
        const labels = history.map(h => h.timestamp.split('T')[1].substring(0,5));

        const createChart = (id, label, field, color) => {
            if (activeCharts[id]) activeCharts[id].destroy();
            activeCharts[id] = new Chart(document.getElementById(id), {
                type: 'line',
                data: { labels, datasets: [{ label, data: history.map(h => h[field]), borderColor: color, tension: 0.3 }] }
            });
        };
        createChart('waveChart', 'Vagues (m)', 'wave', '#0056b3');
        createChart('tempChart', 'Temp (¬∞C)', 'temp', '#ff4081');
    }

    function renderTable(data) {
        const body = document.getElementById('historyTableBody');
        body.innerHTML = data.history.slice(-10).reverse().map(h => `
            <tr>
                <td>${h.timestamp.split('T')[0]}</td>
                <td>${h.timestamp.split('T')[1].substring(0,5)}</td>
                <td>${h.wave}m</td>
                <td>${h.temp}¬∞C</td>
                <td>${h.wind}m/s</td>
                <td><span class="badge ${h.safety === 'safe' ? 'badge-safe' : 'badge-danger'}">${h.safety}</span></td>
            </tr>
        `).join('');
    }

    function filterRegionZones(tab, region) {
        document.querySelectorAll('.region-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.zone-btn').forEach(b => {
            b.style.display = (region === 'all' || b.dataset.region === region) ? 'block' : 'none';
        });
    }
</script>

</body>
</html>
