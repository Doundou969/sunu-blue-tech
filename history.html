<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0056b3">
    <title>Historique - PecheurConnect v3.0 üá∏üá≥</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåä</text></svg>">

    <link rel="manifest" href="./manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* ============================================================
            VARIABLES & RESET
        ============================================================ */
        :root {
            --primary:    #0056b3;
            --primary-dk: #003d7a;
            --accent:     #00c8ff;
            --safe:       #00c853;
            --caution:    #ffd600;
            --warning:    #ff6d00;
            --danger:     #d50000;
            --dark:       #0a1628;
            --bg:         #f0f4f8;
            --card:       #ffffff;
            --radius:     14px;
            --shadow:     0 4px 24px rgba(0,0,0,0.10);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg); min-height: 100vh; color: #333; }

        /* ============================================================
            TOPBAR
        ============================================================ */
        .topbar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dk) 100%);
            padding: 0 30px;
            box-shadow: 0 4px 20px rgba(0,86,179,0.3);
            position: sticky; top: 0; z-index: 100;
        }
        .topbar-inner {
            max-width: 1400px; margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between; height: 64px;
        }
        .topbar-brand {
            font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800;
            color: white; text-decoration: none;
        }
        .topbar-nav { display: flex; gap: 4px; }
        .topbar-nav a {
            color: rgba(255,255,255,0.75); text-decoration: none; font-size: 13px;
            padding: 6px 14px; border-radius: 20px; transition: 0.2s;
        }
        .topbar-nav a.active,
        .topbar-nav a:hover { background: rgba(255,255,255,0.2); color: white; }

        /* Indicateur de statut SW */
        .sw-status {
            display: flex; align-items: center; gap: 6px;
            color: rgba(255,255,255,0.75); font-size: 12px; margin-left: 12px;
        }
        .sw-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: #888; transition: background 0.3s;
        }
        .sw-dot.online  { background: var(--safe); }
        .sw-dot.offline { background: var(--danger); }
        .sw-dot.syncing { background: var(--caution); animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

        .page { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }

        /* ============================================================
            HEADER & BUTTONS
        ============================================================ */
        .page-header {
            background: white; border-radius: var(--radius); padding: 25px;
            box-shadow: var(--shadow); margin-bottom: 24px;
            display: flex; align-items: center; justify-content: space-between;
            flex-wrap: wrap; gap: 20px;
        }
        .page-header h1 { font-family: 'Syne', sans-serif; font-size: 28px; color: var(--primary); }
        .page-header p  { color: #666; margin-top: 4px; font-size: 14px; }

        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn {
            display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px;
            border-radius: 25px; font-weight: 600; cursor: pointer;
            text-decoration: none; border: none; font-size: 14px; transition: 0.2s;
        }
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost   { background: #f0f4f8; color: var(--primary); border: 2px solid #e0e8f0; }

        /* ============================================================
            BANNI√àRE OFFLINE
        ============================================================ */
        .offline-banner {
            display: none; background: #fff3e0; border-radius: var(--radius);
            padding: 14px 20px; margin-bottom: 20px;
            border-left: 4px solid var(--warning); align-items: center; gap: 12px;
        }
        .offline-banner.visible { display: flex; }
        .offline-banner span { flex: 1; font-size: 14px; color: #5d4037; }

        /* ============================================================
            ZONE SELECTOR
        ============================================================ */
        .zone-selector-card {
            background: white; border-radius: var(--radius); padding: 24px;
            box-shadow: var(--shadow); margin-bottom: 24px;
        }
        .region-tabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
        .region-tab {
            padding: 6px 14px; background: #f0f4f8; border-radius: 20px;
            font-size: 12px; cursor: pointer; font-weight: 600; transition: 0.2s;
        }
        .region-tab.active { background: var(--primary); color: white; }
        .zone-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px; }
        .zone-btn {
            padding: 12px; background: #f8f9fa; border: 2px solid #e8ecf0;
            border-radius: 10px; cursor: pointer; text-align: center;
            font-weight: 600; font-size: 12px; transition: 0.2s;
        }
        .zone-btn:hover  { border-color: var(--primary); }
        .zone-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* ============================================================
            STAT CARDS
        ============================================================ */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }
        .stat-card {
            background: white; padding: 20px; border-radius: var(--radius);
            box-shadow: var(--shadow); position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0;
            height: 4px; background: var(--primary);
        }
        .stat-label  { color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value  { font-family: 'Syne', sans-serif; font-size: 32px; font-weight: 800; color: var(--primary); margin: 10px 0; }
        .trend-badge {
            display: inline-block; padding: 4px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 700; text-transform: uppercase;
        }
        .trend-badge.hausse { background: #fff0f0; color: var(--danger); }
        .trend-badge.baisse { background: #f0fff4; color: var(--safe); }
        .trend-badge.stable { background: #f0f7ff; color: var(--primary); }

        /* ============================================================
            SAISONNALIT√â COPERNICUS
        ============================================================ */
        .seasonality-card {
            background: white; border-radius: var(--radius); padding: 24px;
            box-shadow: var(--shadow); margin-bottom: 24px;
            border-top: 5px solid var(--accent);
        }
        .seasonality-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        .seasonality-header h3 { font-family: 'Syne', sans-serif; color: var(--primary); font-size: 18px; }
        .seasonality-body { display: flex; gap: 20px; flex-wrap: wrap; }
        .seasonality-container { position: relative; height: 300px; flex: 2; min-width: 300px; }
        #fishing-advice {
            flex: 1; min-width: 250px; background: #f0f7ff; padding: 15px;
            border-radius: 10px; border-left: 4px solid var(--accent); font-size: 14px;
            align-self: flex-start;
        }
        #fishing-advice strong { display: block; margin-bottom: 8px; }
        #advice-text { line-height: 1.6; }

        /* ============================================================
            CHARTS & TABLE
        ============================================================ */
        .charts-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }
        .chart-card {
            background: white; border-radius: var(--radius); padding: 20px;
            box-shadow: var(--shadow);
        }
        .chart-card h4 { font-family: 'Syne', sans-serif; margin-bottom: 16px; color: #333; }

        .history-table-card {
            background: white; border-radius: var(--radius); padding: 24px;
            box-shadow: var(--shadow); overflow-x: auto;
        }
        .history-table-card h3 { font-family: 'Syne', sans-serif; margin-bottom: 16px; color: #333; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead th {
            background: #f8f9fa; padding: 12px; text-align: left;
            color: #888; border-bottom: 2px solid #eee; font-size: 11px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        tbody td { padding: 12px; border-bottom: 1px solid #f5f5f5; }
        tbody tr:hover { background: #fafbfc; }

        .badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
        .badge-safe   { background: #e8f5e9; color: #2e7d32; }
        .badge-danger { background: #ffebee; color: #b71c1c; }

        /* ============================================================
            √âTATS (Loading, Empty, Error)
        ============================================================ */
        .state-box {
            background: white; border-radius: var(--radius); padding: 60px;
            text-align: center; box-shadow: var(--shadow);
        }
        .spinner-ring {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .state-box p { color: #888; margin-top: 8px; font-size: 14px; }
        .state-box button {
            margin-top: 20px; padding: 10px 24px; background: var(--primary);
            color: white; border: none; border-radius: 25px; cursor: pointer;
            font-weight: 600; font-size: 14px;
        }

        /* ============================================================
            RESPONSIVE
        ============================================================ */
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .topbar-nav  { display: none; }
            .page-header { flex-direction: column; align-items: flex-start; }
            .seasonality-body { flex-direction: column; }
        }
    </style>
</head>
<body>

<!-- ============================================================
    TOPBAR
============================================================ -->
<div class="topbar">
    <div class="topbar-inner">
        <a href="./index.html" class="topbar-brand">üåä PecheurConnect</a>
        <nav class="topbar-nav">
            <a href="./index.html">üó∫Ô∏è Carte</a>
            <a href="./history.html" class="active">üìä Historique</a>
            <a href="./comparator.html">üéØ Comparer</a>
            <a href="./alerts-settings.html">üîî Alertes</a>
        </nav>
        <div class="sw-status">
            <div class="sw-dot" id="swDot"></div>
            <span id="swLabel">Chargement...</span>
        </div>
    </div>
</div>

<!-- ============================================================
    PAGE
============================================================ -->
<div class="page">

    <!-- Banni√®re hors ligne -->
    <div class="offline-banner" id="offlineBanner">
        <i class="fas fa-wifi-slash"></i>
        <span>üì° Mode hors ligne ‚Äî Les donn√©es affich√©es proviennent du cache local.</span>
    </div>

    <!-- En-t√™te -->
    <div class="page-header">
        <div>
            <h1>üìä Historique & Tendances</h1>
            <p>Donn√©es temps r√©el connect√©es √† <strong>Copernicus Marine</strong> üõ∞Ô∏è</p>
        </div>
        <div class="header-actions">
            <a href="./export.html" class="btn btn-ghost">üìÑ Exporter</a>
            <a href="./index.html" class="btn btn-primary">üó∫Ô∏è Carte</a>
        </div>
    </div>

    <!-- S√©lecteur de zones -->
    <div class="zone-selector-card">
        <div class="region-tabs">
            <div class="region-tab active" onclick="filterRegionZones(this, 'all')">Toutes</div>
            <div class="region-tab" onclick="filterRegionZones(this, 'Nord')">Nord</div>
            <div class="region-tab" onclick="filterRegionZones(this, 'Dakar')">Dakar</div>
            <div class="region-tab" onclick="filterRegionZones(this, 'Petite C√¥te')">Petite C√¥te</div>
            <div class="region-tab" onclick="filterRegionZones(this, 'Casamance')">Casamance</div>
        </div>
        <div class="zone-grid" id="zoneGrid"></div>
    </div>

    <!-- √âtats -->
    <div id="stateLoading" class="state-box">
        <div class="spinner-ring"></div>
        <p>Chargement des donn√©es...</p>
    </div>
    <div id="stateEmpty" class="state-box" style="display:none;">
        <i class="fas fa-database" style="font-size:40px;color:#ccc;margin-bottom:16px;display:block;"></i>
        <strong>Aucune donn√©e disponible pour le moment.</strong>
        <p>V√©rifiez votre connexion ou revenez plus tard.</p>
        <button onclick="init()">üîÑ R√©essayer</button>
    </div>

    <!-- Contenu principal -->
    <div id="content" style="display:none;">

        <!-- Calendrier de p√™che Copernicus -->
        <div class="seasonality-card">
            <div class="seasonality-header">
                <h3><i class="fas fa-calendar-check"></i> Calendrier de P√™che Copernicus (Moyennes 10 ans)</h3>
                <span class="badge badge-safe">Scientifiquement Valid√©</span>
            </div>
            <div class="seasonality-body">
                <div class="seasonality-container">
                    <canvas id="seasonalityChart"></canvas>
                </div>
                <div id="fishing-advice">
                    <strong>üí° Analyse Saisonni√®re :</strong>
                    <p id="advice-text">Analyse en cours...</p>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid" id="statsGrid"></div>

        <!-- Graphiques -->
        <div class="charts-grid">
            <div class="chart-card">
                <h4>üåä Vagues (48 derni√®res heures)</h4>
                <canvas id="waveChart"></canvas>
            </div>
            <div class="chart-card">
                <h4>üå°Ô∏è Temp√©rature de l'eau</h4>
                <canvas id="tempChart"></canvas>
            </div>
        </div>

        <!-- Tableau historique -->
        <div class="history-table-card">
            <h3>üìã Derniers relev√©s</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Heure</th>
                        <th>Vagues</th>
                        <th>Temp.</th>
                        <th>Vent</th>
                        <th>S√©curit√©</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>

    </div><!-- /content -->
</div><!-- /page -->

<!-- ============================================================
    SCRIPTS
============================================================ -->
<script>
    // ================================================================
    // √âTAT GLOBAL
    // ================================================================
    let allStats       = {};
    let seasonalityData = {};
    let activeCharts   = {};
    let currentZone    = null;

    const ZONE_REGIONS = {
        'SAINT-LOUIS':          'Nord',
        'KAYAR':                'Nord',
        'DAKAR-YOFF':           'Dakar',
        'DAKAR-HANN':           'Dakar',
        'MBOUR-JOAL':           'Petite C√¥te',
        'SALY':                 'Petite C√¥te',
        'CASAMANCE-ZIGUINCHOR': 'Casamance'
    };

    // ================================================================
    // INITIALISATION
    // ================================================================
    document.addEventListener('DOMContentLoaded', () => {
        registerServiceWorker();
        setupOnlineDetection();
        init();
    });

    async function init() {
        showState('loading');
        try {
            // Chargement simultan√© des deux sources
            const [statsRes, seasonRes] = await Promise.allSettled([
                fetch('./logs/stats/all_zones.json'),
                fetch('./seasonality_data.json')      // ‚Üê chemin corrig√©
            ]);

            // Traitement des stats
            if (statsRes.status === 'fulfilled' && statsRes.value.ok) {
                allStats = await statsRes.value.json();
            } else {
                console.warn('[History] Impossible de charger all_zones.json');
                showState('empty');
                return;
            }

            // Traitement de la saisonnalit√© (non bloquant)
            if (seasonRes.status === 'fulfilled' && seasonRes.value.ok) {
                seasonalityData = await seasonRes.value.json();
            } else {
                console.warn('[History] Donn√©es de saisonnalit√© non disponibles, utilisation des donn√©es par d√©faut.');
                seasonalityData = getDefaultSeasonality();
            }

            buildZoneButtons(Object.keys(allStats));
            const firstZone = Object.keys(allStats)[0];
            if (firstZone) selectZone(firstZone);

            showState('content');

        } catch (err) {
            console.error('[History] Erreur init :', err);
            showState('empty');
        }
    }

    function showState(state) {
        document.getElementById('stateLoading').style.display = state === 'loading'  ? 'block' : 'none';
        document.getElementById('stateEmpty').style.display   = state === 'empty'    ? 'block' : 'none';
        document.getElementById('content').style.display      = state === 'content'  ? 'block' : 'none';
    }

    // ================================================================
    // SERVICE WORKER
    // ================================================================
    async function registerServiceWorker() {
        if (!('serviceWorker' in navigator)) return;

        try {
            const reg = await navigator.serviceWorker.register('./sw.js');
            console.log('[History] SW enregistr√© :', reg.scope);

            // √âcouter les messages du SW (ex: DATA_UPDATED depuis sync background)
            navigator.serviceWorker.addEventListener('message', event => {
                if (event.data?.type === 'DATA_UPDATED') {
                    console.log('[History] Nouvelles donn√©es disponibles, rechargement...');
                    init(); // Rafra√Æchir les donn√©es
                }
            });

            // Demander la version du SW (avec MessageChannel pour √©viter l'erreur)
            getSwVersion();

        } catch (err) {
            console.warn('[History] √âchec enregistrement SW :', err);
        }
    }

    /**
     * Communiquer avec le SW via MessageChannel
     * CORRECTION : √©vite "message channel closed before response received"
     */
    function sendSwMessage(message) {
        return new Promise((resolve, reject) => {
            if (!navigator.serviceWorker.controller) {
                reject(new Error('Aucun SW actif'));
                return;
            }

            const channel = new MessageChannel();
            const timeout = setTimeout(() => {
                reject(new Error('SW timeout'));
            }, 5000);

            channel.port1.onmessage = event => {
                clearTimeout(timeout);
                if (event.data?.success) {
                    resolve(event.data);
                } else {
                    reject(new Error(event.data?.error || 'Erreur SW'));
                }
            };

            navigator.serviceWorker.controller.postMessage(message, [channel.port2]);
        });
    }

    async function getSwVersion() {
        try {
            const res = await sendSwMessage({ type: 'GET_VERSION' });
            console.log('[History] Version SW :', res.version);
            updateSwStatus('online', `SW ${res.version}`);
        } catch (err) {
            console.warn('[History] Version SW non disponible :', err.message);
        }
    }

    function updateSwStatus(state, label) {
        const dot   = document.getElementById('swDot');
        const lbl   = document.getElementById('swLabel');
        dot.className = `sw-dot ${state}`;
        lbl.textContent = label || state;
    }

    // ================================================================
    // D√âTECTION EN LIGNE / HORS LIGNE
    // ================================================================
    function setupOnlineDetection() {
        const banner = document.getElementById('offlineBanner');

        function update() {
            if (navigator.onLine) {
                banner.classList.remove('visible');
                updateSwStatus('online', 'En ligne');
            } else {
                banner.classList.add('visible');
                updateSwStatus('offline', 'Hors ligne');
            }
        }

        window.addEventListener('online',  update);
        window.addEventListener('offline', update);
        update(); // √©tat initial
    }

    // ================================================================
    // GESTION DES ZONES
    // ================================================================
    function buildZoneButtons(zones) {
        const grid = document.getElementById('zoneGrid');
        grid.innerHTML = '';
        zones.forEach(name => {
            const btn = document.createElement('div');
            btn.className = 'zone-btn';
            btn.textContent = name;
            btn.onclick = () => selectZone(name);
            btn.dataset.region = ZONE_REGIONS[name] || 'Dakar';
            grid.appendChild(btn);
        });
    }

    function selectZone(name) {
        currentZone = name;
        document.querySelectorAll('.zone-btn').forEach(b => {
            b.classList.toggle('active', b.textContent === name);
        });
        const data = allStats[name];
        if (!data) return;
        renderStats(data);
        renderCharts(data);
        renderTable(data);
        renderSeasonality(name);
    }

    function filterRegionZones(tab, region) {
        document.querySelectorAll('.region-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.zone-btn').forEach(b => {
            b.style.display = (region === 'all' || b.dataset.region === region) ? '' : 'none';
        });
    }

    // ================================================================
    // RENDU DES STATS
    // ================================================================
    function renderStats(data) {
        const s = data.statistics;
        document.getElementById('statsGrid').innerHTML = `
            <div class="stat-card">
                <div class="stat-label">Vagues Moy.</div>
                <div class="stat-value">${s.waves.avg}m</div>
                <span class="trend-badge ${s.waves.trend}">${s.waves.trend}</span>
            </div>
            <div class="stat-card">
                <div class="stat-label">Temp√©rature</div>
                <div class="stat-value">${s.temperature.avg}¬∞C</div>
                <span class="trend-badge ${s.temperature.trend}">${s.temperature.trend}</span>
            </div>
            <div class="stat-card">
                <div class="stat-label">Vent</div>
                <div class="stat-value">${s.wind.avg}m/s</div>
                <span class="trend-badge ${s.wind.trend}">${s.wind.trend}</span>
            </div>
            ${s.current ? `
            <div class="stat-card">
                <div class="stat-label">Courants</div>
                <div class="stat-value">${s.current.avg}kn</div>
                <span class="trend-badge ${s.current.trend}">${s.current.trend}</span>
            </div>` : ''}
        `;
    }

    // ================================================================
    // RENDU SAISONNALIT√â
    // ================================================================
    function renderSeasonality(zoneName) {
        const key = Object.keys(seasonalityData).find(
            k => zoneName.toUpperCase().includes(k.toUpperCase())
        ) || 'Dakar';

        const points = seasonalityData[key];
        const ctx = document.getElementById('seasonalityChart').getContext('2d');

        if (activeCharts.season) activeCharts.season.destroy();

        activeCharts.season = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan','F√©v','Mar','Avr','Mai','Jui','Jul','Ao√ª','Sep','Oct','Nov','D√©c'],
                datasets: [{
                    label: 'Potentiel de P√™che %',
                    data: points,
                    borderColor: '#00c8ff',
                    fill: true,
                    backgroundColor: 'rgba(0,200,255,0.1)',
                    tension: 0.4,
                    pointBackgroundColor: '#00c8ff',
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => ` ${ctx.parsed.y}% de potentiel`
                        }
                    }
                },
                scales: {
                    y: { min: 0, max: 100, ticks: { callback: v => v + '%' } }
                }
            }
        });

        const month = new Date().getMonth();
        const val   = points[month];
        const moisNom = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'][month];

        let conseil = '';
        if (val >= 80) {
            conseil = `üü¢ <strong>P√©riode d'Upwelling intense</strong> ‚Äî Eaux froides remontantes riches en nutriments. La p√™che est optimale ce mois-ci !`;
        } else if (val >= 60) {
            conseil = `üü° <strong>Conditions favorables</strong> ‚Äî Bonne activit√© halieutique, sortie recommand√©e en matin√©e.`;
        } else if (val >= 40) {
            conseil = `üü† <strong>Conditions moyennes</strong> ‚Äî Eaux plus chaudes, les bancs de poissons restent en profondeur.`;
        } else {
            conseil = `üî¥ <strong>P√©riode creuse</strong> ‚Äî Eaux chaudes, faible activit√©. Pr√©f√©rez les zones profondes.`;
        }

        document.getElementById('advice-text').innerHTML = `
            <strong style="color:var(--primary)">${moisNom} ‚Äî Indice ${val}%</strong><br><br>
            ${conseil}
        `;
    }

    // ================================================================
    // RENDU DES GRAPHIQUES
    // ================================================================
    function renderCharts(data) {
        const history = data.history.slice(-48);
        const labels  = history.map(h => h.timestamp.split('T')[1].substring(0, 5));

        const chartDefaults = {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: false } }
        };

        const createChart = (id, label, field, color) => {
            if (activeCharts[id]) activeCharts[id].destroy();
            activeCharts[id] = new Chart(document.getElementById(id), {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label,
                        data: history.map(h => h[field]),
                        borderColor: color,
                        backgroundColor: color + '20',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2
                    }]
                },
                options: chartDefaults
            });
        };

        createChart('waveChart', 'Vagues (m)',  'wave', '#0056b3');
        createChart('tempChart', 'Temp. (¬∞C)', 'temp', '#ff4081');
    }

    // ================================================================
    // RENDU DU TABLEAU
    // ================================================================
    function renderTable(data) {
        const body = document.getElementById('historyTableBody');
        const rows = data.history.slice(-10).reverse();

        if (!rows.length) {
            body.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#888;padding:30px;">Aucun relev√© disponible</td></tr>`;
            return;
        }

        body.innerHTML = rows.map(h => {
            const date  = h.timestamp.split('T')[0];
            const heure = h.timestamp.split('T')[1]?.substring(0, 5) || '--';
            const safe  = h.safety === 'safe';
            return `
                <tr>
                    <td>${date}</td>
                    <td>${heure}</td>
                    <td>${h.wave ?? '--'}m</td>
                    <td>${h.temp ?? '--'}¬∞C</td>
                    <td>${h.wind ?? '--'}m/s</td>
                    <td>
                        <span class="badge ${safe ? 'badge-safe' : 'badge-danger'}">
                            ${safe ? '‚úÖ S√ªr' : '‚ö†Ô∏è Danger'}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // ================================================================
    // DONN√âES SAISONNALIT√â PAR D√âFAUT (si fichier non dispo)
    // ================================================================
    function getDefaultSeasonality() {
        return {
            'Dakar':     [65, 70, 80, 85, 75, 60, 55, 50, 58, 65, 70, 65],
            'Nord':      [70, 75, 85, 90, 80, 65, 60, 55, 62, 68, 72, 68],
            'Casamance': [55, 60, 65, 70, 75, 65, 55, 50, 52, 58, 60, 57]
        };
    }
</script>

</body>
</html>
