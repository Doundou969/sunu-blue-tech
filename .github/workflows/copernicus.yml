name: PecheurConnect Update

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install copernicusmarine==1.3.3 xarray==2024.1.0 netCDF4==1.6.5 numpy==1.26.4 pandas==2.2.0 requests==2.31.0 python-dotenv==1.0.1
      
      - name: ğŸŒŠ Run script
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_ID: ${{ secrets.TG_ID }}
          COPERNICUS_USERNAME: ${{ secrets.COPERNICUS_USERNAME }}
          COPERNICUS_PASSWORD: ${{ secrets.COPERNICUS_PASSWORD }}
        run: python script_peche.py
      
      - name: âœ… Verify output
        run: |
          if [ -f data.json ]; then
            echo "âœ… data.json crÃ©Ã©"
            ls -lh data.json
          else
            echo "âŒ data.json manquant"
            exit 1
          fi
      
      - name: ğŸ’¾ Commit and Push
        run: |
          git config user.name "PecheurConnect Bot"
          git config user.email "bot@pecheurconnect.sn"
          git add data.json logs/ || true
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸŒŠ Update $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push || echo "Rien Ã  pusher"
