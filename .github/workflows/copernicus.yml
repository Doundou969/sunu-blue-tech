name: PecheurConnect Update

on:
  workflow_dispatch: # Permet de lancer manuellement depuis l'onglet Actions
  schedule:
    - cron: "0 */6 * * *" # Ex√©cution toutes les 6 heures (align√© sur Copernicus)

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Autorise le bot √† pousser les fichiers data.json et logs
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip' # Acc√©l√®re les ex√©cutions futures

      - name: üìÅ Prepare Directories
        run: mkdir -p logs/history logs/stats

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Installation forc√©e des modules n√©cessaires pour PecheurConnect v3.0
          pip install aiohttp requests numpy copernicusmarine

      - name: üåä Run PecheurConnect Script
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_ID: ${{ secrets.TG_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          COPERNICUS_USERNAME: ${{ secrets.COPERNICUS_USERNAME }}
          COPERNICUS_PASSWORD: ${{ secrets.COPERNICUS_PASSWORD }}
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        run: python script_peche.py

      - name: ‚úÖ Verify Output
        run: |
          if [ -f data.json ]; then
            echo "‚úÖ data.json g√©n√©r√© avec succ√®s."
          else
            echo "‚ùå Erreur : data.json introuvable."
            exit 1
          fi

      - name: üíæ Commit and Push Changes
        run: |
          git config user.name "PecheurConnect Bot"
          git config user.email "bot@pecheurconnect.sn"
          
          # Ajout de data.json, des statistiques et de l'historique
          git add data.json logs/ seasonality_data.json
          
          # Commit seulement s'il y a des changements pour √©viter les erreurs de pipeline
          git diff --quiet && git diff --staged --quiet || (git commit -m "üåä Update $(date -u '+%Y-%m-%d %H:%M UTC')" && git push)
