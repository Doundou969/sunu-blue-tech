name: PecheurConnect Update

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: üìÅ Prepare Directories
        run: mkdir -p logs/history logs/stats

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: üîç Debug secrets (noms uniquement)
        run: |
          echo "TELEGRAM_BOT_TOKEN d√©fini : ${{ secrets.TELEGRAM_BOT_TOKEN != '' }}"
          echo "TG_ID d√©fini             : ${{ secrets.TG_ID != '' }}"
          echo "COPERNICUS_USERNAME      : ${{ secrets.COPERNICUS_USERNAME != '' }}"
          echo "OPENWEATHER_API_KEY      : ${{ secrets.OPENWEATHER_API_KEY != '' }}"

      - name: üî¨ Diagnostic copernicusmarine
        run: |
          echo "=== Version install√©e ==="
          pip show copernicusmarine | grep -E "Name|Version|Location"
          echo ""
          echo "=== Test import direct ==="
          python -c "
          import sys
          print('Python:', sys.version)
          try:
              import copernicusmarine as cm
              print('OK Import ‚Äî version:', cm.__version__)
          except ImportError as e:
              print('FAIL ImportError:', e)
          except Exception as e:
              import traceback
              print('FAIL', type(e).__name__, ':', e)
              traceback.print_exc()
          "

      - name: üåä Run PecheurConnect Script
        timeout-minutes: 20
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_TOKEN:           ${{ secrets.TG_TOKEN }}
          TG_ID:              ${{ secrets.TG_ID }}
          COPERNICUS_USERNAME: ${{ secrets.COPERNICUS_USERNAME }}
          COPERNICUS_PASSWORD: ${{ secrets.COPERNICUS_PASSWORD }}
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        run: python script_peche.py

      - name: ‚úÖ Verify Outputs
        run: |
          if [ -f data.json ]; then
            echo "‚úÖ data.json g√©n√©r√© ($(wc -c < data.json) octets)"
            python -c "
          import json
          with open('data.json') as f:
              d = json.load(f)
          s = d.get('stats', {})
          print(f\"  Zones : {d['meta']['total_zones']}\")
          print(f\"  Score moyen : {s.get('score_moyen', '?')}/10\")
          print(f\"  Danger : {s.get('zones_count', {}).get('danger', 0)} zones\")
          print(f\"  Sources : {d['meta']['sources']}\")
            "
          else
            echo "‚ùå data.json manquant ‚Äî arr√™t."
            exit 1
          fi

      - name: üíæ Commit and Push
        run: |
          git config user.name  "PecheurConnect Bot"
          git config user.email "bot@pecheurconnect.sn"
          git add data.json
          [ -f seasonality_data.json ] && git add seasonality_data.json || true
          git diff --staged --quiet || \
            git commit -m "üåä Update $(date -u '+%Y-%m-%d %H:%M UTC')" && \
            git push

      - name: üîî Notify failure on Telegram
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_TOKEN:           ${{ secrets.TG_TOKEN }}
          TG_ID:              ${{ secrets.TG_ID }}
        run: |
          TOKEN="${TELEGRAM_BOT_TOKEN:-$TG_TOKEN}"
          if [ -n "$TOKEN" ] && [ -n "$TG_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
              -d chat_id="${TG_ID}" \
              -d parse_mode="HTML" \
              -d text="‚ö†Ô∏è <b>PecheurConnect</b> ‚Äî √âchec workflow
          üïë $(date -u '+%Y-%m-%d %H:%M UTC')
          üîó ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          else
            echo "Telegram non configur√©."
          fi
