name: PecheurConnect Update

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"  # Toutes les 6h UTC

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“ Prepare Directories
        run: mkdir -p logs/history logs/stats

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Debug secrets (noms uniquement, jamais les valeurs)
        run: |
          echo "TELEGRAM_BOT_TOKEN dÃ©fini : ${{ secrets.TELEGRAM_BOT_TOKEN != '' }}"
          echo "TG_ID dÃ©fini             : ${{ secrets.TG_ID != '' }}"
          echo "COPERNICUS_USERNAME      : ${{ secrets.COPERNICUS_USERNAME != '' }}"
          echo "OPENWEATHER_API_KEY      : ${{ secrets.OPENWEATHER_API_KEY != '' }}"

      - name: ğŸŒŠ Run PecheurConnect Script
        timeout-minutes: 20
        env:
          # â”€â”€ Telegram â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Le script accepte TELEGRAM_BOT_TOKEN ou TG_TOKEN (fallback)
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_TOKEN:           ${{ secrets.TG_TOKEN }}           # ancien nom â€” conservÃ© pour compatibilitÃ©
          TG_ID:              ${{ secrets.TG_ID }}
          # â”€â”€ Copernicus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          COPERNICUS_USERNAME: ${{ secrets.COPERNICUS_USERNAME }}
          COPERNICUS_PASSWORD: ${{ secrets.COPERNICUS_PASSWORD }}
          # â”€â”€ OpenWeather â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          OPENWEATHER_API_KEY: ${{ secrets.OPENWEATHER_API_KEY }}
        run: python script_peche.py

      - name: âœ… Verify Outputs
        run: |
          if [ -f data.json ]; then
            echo "âœ… data.json gÃ©nÃ©rÃ© ($(wc -c < data.json) octets)"
            # Afficher les stats sans exposer de donnÃ©es sensibles
            python -c "
          import json
          with open('data.json') as f:
              d = json.load(f)
          s = d.get('stats', {})
          print(f\"  Zones : {d['meta']['total_zones']}\")
          print(f\"  Score moyen : {s.get('score_moyen', '?')}/10\")
          print(f\"  Danger : {s.get('zones_count', {}).get('danger', 0)} zones\")
          print(f\"  Sources : {d['meta']['sources']}\")
            "
          else
            echo "âŒ data.json manquant â€” arrÃªt."
            exit 1
          fi

      - name: ğŸ’¾ Commit and Push
        run: |
          git config user.name  "PecheurConnect Bot"
          git config user.email "bot@pecheurconnect.sn"

          git add data.json
          [ -f seasonality_data.json ] && git add seasonality_data.json || true

          git diff --staged --quiet || \
            git commit -m "ğŸŒŠ Update $(date -u '+%Y-%m-%d %H:%M UTC')" && \
            git push

      - name: ğŸ”” Notify failure on Telegram
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_TOKEN:           ${{ secrets.TG_TOKEN }}
          TG_ID:              ${{ secrets.TG_ID }}
        run: |
          TOKEN="${TELEGRAM_BOT_TOKEN:-$TG_TOKEN}"
          if [ -n "$TOKEN" ] && [ -n "$TG_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TOKEN}/sendMessage" \
              -d chat_id="${TG_ID}" \
              -d parse_mode="HTML" \
              -d text="âš ï¸ <b>PecheurConnect</b> â€” Ã‰chec du workflow GitHub Actions
          ğŸ•‘ $(date -u '+%Y-%m-%d %H:%M UTC')
          ğŸ”— VÃ©rifiez les logs : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          else
            echo "Telegram non configurÃ© â€” notification ignorÃ©e."
          fi
