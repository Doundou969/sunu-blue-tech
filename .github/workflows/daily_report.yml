name: PecheurConnect-Full

on:
  schedule:
    - cron: '0 */6 * * *'  # Toutes les 6h
  workflow_dispatch:        # Lancement manuel

jobs:
  run-pecheurconnect:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ------------------------------
      - name: ğŸ“‚ Checkout du code
        uses: actions/checkout@v3

      # ------------------------------
      - name: ğŸ Installer Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # ------------------------------
      - name: ğŸ“¦ Installer dÃ©pendances
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade numpy requests copernicusmarine

      # ------------------------------
      - name: ğŸš€ ExÃ©cuter PecheurConnect + gÃ©nÃ©ration Telegram
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_ID: ${{ secrets.TG_ID }}
          COPERNICUS_USERNAME: ${{ secrets.COPERNICUS_USERNAME }}
          COPERNICUS_PASSWORD: ${{ secrets.COPERNICUS_PASSWORD }}
        run: |
          echo "ğŸ“Œ DÃ©but PecheurConnect"
          LOG_FILE="pecheurconnect_$(date +'%Y%m%d_%H%M%S').log"
          set -o pipefail

          python - <<'EOF' 2>&1 | tee "$LOG_FILE" || (
            echo "âš ï¸ Erreur dÃ©tectÃ©e dans le script !"
            curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
                 -d chat_id="${TG_ID}" \
                 -d text="ğŸš¨ CRASH PecheurConnect ! VÃ©rifie GitHub Actions."
            exit 0
          )
import json, datetime, requests

# Charger donnÃ©es
with open("data.json") as f:
    data = json.load(f)

now = datetime.datetime.utcnow().strftime("%d/%m/%Y %H:%M")
report = f"ğŸŒŠ <b>PÃŠCHEURCONNECT ğŸ‡¸ğŸ‡³ â€“ Rapport mer</b>\nğŸ“… {now} GMT\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n"
alertes = []

# Trier par danger : houle + courant
data_sorted = sorted(data, key=lambda x: (x["houle"], x["courant"]), reverse=True)

for zone in data_sorted:
    houle = zone["houle"]
    courant = zone["courant"]
    if houle >= 2.3:
        emoji = "ğŸ”´"
        alert = "ğŸš¨ Danger !"
    elif houle >= 1.4:
        emoji = "ğŸŸ¡"
        alert = "âš ï¸ Prudence"
    else:
        emoji = "ğŸŸ¢"
        alert = "âœ… Sortie OK"

    report += f"ğŸ“ <b>{zone['zone']}</b> : Houle {houle} m, Courant {courant} km/h â†’ {emoji} {alert}\n"

    if emoji in ["ğŸ”´", "ğŸŸ¡"]:
        alertes.append(f"{zone['zone']} ({houle} m)")

# Zone plus froide pour conseil Ã©conomique
best_zone = min(data, key=lambda x: x["sst"])
report += f"\nâ›½ <b>Conseil Ã©conomique :</b> Zone {best_zone['zone']} ({best_zone['sst']}Â°C) â€“ potentiel poisson Ã©levÃ©\n"
report += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nâ„¹ï¸ Restez prudents et suivez les alertes\n"

if alertes:
    header = "ğŸš¨ <b>ALERTES MER</b> ğŸš¨\n" + ", ".join(alertes) + "\n\n"
    report = header + report

# Envoi Telegram
requests.post(
    f"https://api.telegram.org/bot{TG_TOKEN}/sendMessage",
    data={"chat_id": TG_ID, "text": report, "parse_mode": "HTML"}
)

print(report)
EOF

          echo "âœ… Script exÃ©cutÃ© et message Telegram envoyÃ©"

      # ------------------------------
      - name: ğŸŒ Sauvegarde et versioning data.json
        run: |
          git config --global user.name "PecheurConnect-Bot"
          git config --global user.email "bot@pecheurconnect.sn"

          if [ -f "data.json" ]; then
            TIMESTAMP=$(date +'%Y%m%d_%H%M%S')
            cp data.json "data_backup_$TIMESTAMP.json"

            git add data.json data_backup_*.json
            if [ -n "$(git status --porcelain)" ]; then
              git commit -m "ğŸ“Š Mise Ã  jour PecheurConnect : $TIMESTAMP"
              git push origin main
              echo "âœ… data.json pushÃ© et versionnÃ©"
            else
              echo "â„¹ï¸ Aucun changement dÃ©tectÃ© dans data.json"
            fi
          else
            echo "âš ï¸ data.json non trouvÃ©"
