name: Sunu-Blue-Tech Auto

on:
  schedule:
    - cron: '0 5 * * *'   # 10h Dakar
    - cron: '0 15 * * *'  # 20h Dakar
  workflow_dispatch:

jobs:
  run-script:
    runs-on: ubuntu-latest
    
    steps:
      - name: R√©cup√©rer le code
        uses: actions/checkout@v4

      - name: Installer Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Installer TOUTES les d√©pendances (ROBUSTE)
        run: |
          echo "üì¶ Mise √† jour pip..."
          pip install --upgrade pip setuptools wheel
          
          echo "üìã V√©rification requirements.txt..."
          ls -la requirements.txt || { echo "‚ùå requirements.txt MANQUANT !"; exit 1; }
          
          echo "üîß Installation d√©pendances..."
          pip install -r requirements.txt --timeout=120
          
          echo "‚úÖ D√©pendances install√©es !"
          pip list

      ######################################################################
      # STEP 5 DEBUG URGENT - REMPLACE L'ANCIEN
      ######################################################################
      - name: Lancer le script de p√™che (DEBUG URGENT)
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_ID: ${{ secrets.TG_ID }}
          COPERNICUS_USERNAME: ${{ secrets.COPERNICUS_USERNAME }}
          COPERNICUS_PASSWORD: ${{ secrets.COPERNICUS_PASSWORD }}
        run: |
          echo "üî• DEBUG URGENT - $(date)"
          echo "üìÇ R√©pertoire: $(pwd)"
          echo "üêç Python: $(python --version)"
          echo "üìç Python: $(which python)"
          
          echo "üìã FICHIERS PYTHON:"
          find . -name "*.py" -type f || echo "‚ùå AUCUN .py trouv√© !"
          
          echo "üß™ TEST BASE PYTHON:"
          python -c "
import sys, os
print('‚úÖ Python de base OK')
print('üìç Working dir:', os.getcwd())
" || { echo "‚ùå Python cass√©"; exit 1; }
          
          echo "üîç V√âRIFICATION script_peche.py:"
          if [ -f "script_peche.py" ]; then
            echo "‚úÖ script_peche.py trouv√© !"
            echo "üîé Test syntaxe..."
            python -m py_compile script_peche.py || echo "‚ö†Ô∏è Syntaxe OK"
            
            echo "üöÄ LANCEMENT script_peche.py:"
            python script_peche.py 2>&1 || {
              echo "üí• ERREUR FATALE:"
              echo "   Code sortie: \$?"
              echo "   üìÑ Voir traceback ci-dessus ‚Üë‚Üë‚Üë"
              exit 1
            }
            echo "üéâ SUCC√àS script_peche.py !"
          else
            echo "‚ùå script_peche.py ABSENT ! Fichiers trouv√©s:"
            ls -la *.py 2>/dev/null || echo "‚ùå AUCUN .py √† la racine"
            exit 1
          fi
        shell: bash
        timeout-minutes: 5

      - name: Notification succ√®s (optionnel)
        if: success()
        env:
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_ID: ${{ secrets.TG_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_ID}" \
            -d text="‚úÖ Sunu-Blue-Tech: P√™che r√©ussie ! üêü"
