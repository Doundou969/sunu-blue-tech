name: üì° Copernicus Auto Update ‚Äì PecheurConnect

on:
  schedule:
    - cron: "0 6 * * *"   # Tous les jours √† 06h UTC
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ R√©cup√©rer le d√©p√¥t
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0   # IMPORTANT pour git pull --rebase

    # 2Ô∏è‚É£ Installer Python
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    # 3Ô∏è‚É£ Installer d√©pendances
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install copernicusmarine xarray netCDF4 numpy pandas requests python-telegram-bot python-dotenv

    # 4Ô∏è‚É£ Lancer le script Copernicus ‚Üí data.json + Telegram
    - name: Run Copernicus PecheurConnect script
      env:
        COPERNICUSMARINE_USERNAME: ${{ secrets.COPERNICUS_USERNAME }}
        COPERNICUSMARINE_PASSWORD: ${{ secrets.COPERNICUS_PASSWORD }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python script_peche.py

    # 5Ô∏è‚É£ Commit + Push ROBUSTE (ANTI-CONFLIT)
    - name: Commit and push data.json safely
      run: |
        git config user.name "Copernicus Bot"
        git config user.email "bot@copernicus.eu"

        # üîê R√©cup√®re les changements distants (GitHub Pages / autres workflows)
        git pull origin main --rebase

        # üì¶ Commit uniquement si data.json a chang√©
        git add data.json
        git commit -m "üì° Update Copernicus data (auto)" || echo "No changes to commit"

        # üöÄ Push s√©curis√©
        git push origin main
