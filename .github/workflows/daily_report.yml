name: ğŸ“¡ Copernicus Auto Update â€“ PecheurConnect

on:
  schedule:
    - cron: "0 */6 * * *"   # toutes les 6 heures
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install copernicusmarine xarray netCDF4 numpy pandas requests python-telegram-bot

      - name: ğŸš€ Run PecheurConnect script
        env:
          COPERNICUSMARINE_USERNAME: ${{ secrets.COPERNICUS_USERNAME }}
          COPERNICUSMARINE_PASSWORD: ${{ secrets.COPERNICUS_PASSWORD }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_ID: ${{ secrets.TG_ID }}
        run: python script_peche.py

      - name: ğŸ“¤ Commit & Push data.json (SAFE MODE)
        run: |
          git config user.name "Copernicus Bot"
          git config user.email "bot@copernicus.eu"

          # ğŸ§¹ Sauvegarde locale
          git stash push -u -m "auto-stash Copernicus" || echo "Nothing to stash"

          # ğŸ”„ Sync remote
          git pull origin main --rebase

          # â™»ï¸ Restore data.json gÃ©nÃ©rÃ©
          git stash pop || echo "Nothing to pop"

          # ğŸ“¦ Commit si changement
          git add data.json
          git commit -m "ğŸ“¡ Update Copernicus data (auto)" || echo "No changes to commit"

          # ğŸš€ Push final
          git push origin main
