<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="PecheurConnect ‚Äî S√©curit√© maritime en temps r√©el pour les p√™cheurs s√©n√©galais. 18 zones surveill√©es 24h/24.">
    <meta name="theme-color" content="#0a1628">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PecheurConnect">
    <meta property="og:title" content="PecheurConnect üá∏üá≥">
    <meta property="og:description" content="S√©curit√© maritime en temps r√©el ‚Äî 18 zones au S√©n√©gal">
    <meta property="og:type" content="website">

    <title>PecheurConnect v3.0 üá∏üá≥ | S√©curit√© Maritime S√©n√©gal</title>

    <link rel="manifest" href="./manifest.json">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>

    <style>
        /* ============================================================
           VARIABLES
        ============================================================ */
        :root {
            --primary:    #0056b3;
            --primary-dk: #003d7a;
            --primary-lt: #1a73e8;
            --accent:     #00d4ff;
            --accent2:    #00ff9d;
            --safe:       #00c853;
            --caution:    #ffd600;
            --warning:    #ff6d00;
            --danger:     #d50000;
            --dark:       #0a1628;
            --panel:      rgba(8,18,36,0.88);
            --border:     rgba(255,255,255,0.10);
            --text:       rgba(255,255,255,0.90);
            --text-dim:   rgba(255,255,255,0.50);
            --radius:     12px;
            --radius-sm:  8px;
            --shadow:     0 8px 32px rgba(0,0,0,0.35);
            --shadow-sm:  0 3px 12px rgba(0,0,0,0.25);
        }

        /* ============================================================
           RESET
        ============================================================ */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--dark);
            color: var(--text);
        }

        button { font-family: 'DM Sans', sans-serif; }
        a      { font-family: 'DM Sans', sans-serif; }

        /* ============================================================
           MAP
        ============================================================ */
        #map {
            position: fixed;
            inset: 0;
            z-index: 1;
        }

        /* ============================================================
           LOADING SCREEN
        ============================================================ */
        #loadingScreen {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: var(--dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.7s ease, visibility 0.7s ease;
        }

        #loadingScreen.hide {
            opacity: 0;
            visibility: hidden;
        }

        .ls-wave {
            font-size: 52px;
            margin-bottom: 12px;
            animation: bob 2s ease-in-out infinite;
        }

        @keyframes bob {
            0%, 100% { transform: translateY(0); }
            50%       { transform: translateY(-8px); }
        }

        .ls-title {
            font-family: 'Syne', sans-serif;
            font-size: 30px;
            font-weight: 800;
            color: white;
            letter-spacing: -0.5px;
            margin-bottom: 6px;
        }

        .ls-sub {
            font-size: 14px;
            color: var(--text-dim);
            margin-bottom: 40px;
        }

        .ls-bar-wrap {
            width: 220px;
            height: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 14px;
        }

        .ls-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--primary-lt), var(--accent));
            border-radius: 3px;
            animation: bar-fill 2.2s ease forwards;
        }

        @keyframes bar-fill {
            0%   { width: 0%; }
            60%  { width: 75%; }
            100% { width: 100%; }
        }

        .ls-status {
            font-size: 12px;
            color: var(--text-dim);
        }

        /* ============================================================
           OFFLINE BAR
        ============================================================ */
        .offline-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 8000;
            background: var(--warning);
            color: white;
            text-align: center;
            padding: 9px 16px;
            font-size: 13px;
            font-weight: 600;
            display: none;
        }
        .offline-bar.show { display: block; }

        /* ============================================================
           LEFT PANEL
        ============================================================ */
        .left-panel {
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 500;
            width: 302px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Brand Card */
        .brand-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dk) 100%);
            border-radius: var(--radius);
            padding: 16px 18px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.12);
        }

        .brand-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .brand-name {
            font-family: 'Syne', sans-serif;
            font-size: 19px;
            font-weight: 800;
            color: white;
            letter-spacing: -0.3px;
        }

        .brand-v {
            font-size: 11px;
            font-weight: 700;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 3px 9px;
            border-radius: 20px;
        }

        .brand-chips {
            display: flex;
            gap: 7px;
            flex-wrap: wrap;
        }

        .chip {
            background: rgba(255,255,255,0.14);
            color: rgba(255,255,255,0.92);
            font-size: 11px;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .live-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent2);
            animation: pulse-live 2s ease infinite;
        }

        @keyframes pulse-live {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%       { opacity: 0.5; transform: scale(1.4); }
        }

        /* Nav Card */
        .nav-card {
            background: var(--panel);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border-radius: var(--radius);
            padding: 10px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 9px 4px;
            border-radius: var(--radius-sm);
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.07);
            color: rgba(255,255,255,0.72);
            text-decoration: none;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: rgba(0,212,255,0.14);
            border-color: var(--accent);
            color: white;
            transform: translateY(-1px);
        }

        .nav-item.current {
            background: rgba(0,86,179,0.4);
            border-color: var(--primary-lt);
            color: white;
        }

        .nav-icon { font-size: 16px; line-height: 1; }

        /* Filter Card */
        .filter-card {
            background: var(--panel);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border-radius: var(--radius);
            padding: 12px 14px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .filter-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 9px;
        }

        .filter-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .pill {
            padding: 5px 11px;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 20px;
            color: rgba(255,255,255,0.75);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pill:hover  { background: rgba(255,255,255,0.14); color: white; }

        .pill.active {
            background: var(--primary);
            border-color: var(--primary-lt);
            color: white;
            font-weight: 600;
        }

        /* Search Card */
        .search-card {
            background: var(--panel);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border-radius: var(--radius);
            padding: 11px 15px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 9px;
        }

        .search-icon { font-size: 14px; opacity: 0.5; }

        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-family: 'DM Sans', sans-serif;
            font-size: 13px;
        }

        .search-input::placeholder { color: var(--text-dim); }

        /* ============================================================
           STATS PANEL (BOTTOM LEFT)
        ============================================================ */
        .stats-panel {
            position: fixed;
            bottom: 24px;
            left: 16px;
            z-index: 500;
            background: var(--panel);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border-radius: var(--radius);
            padding: 14px 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            min-width: 272px;
        }

        .stats-update {
            display: flex;
            align-items: center;
            gap: 7px;
            margin-bottom: 12px;
        }

        .stats-update-text {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent);
        }

        .safety-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .safety-box {
            background: rgba(255,255,255,0.05);
            border-radius: var(--radius-sm);
            padding: 9px 5px;
            text-align: center;
        }

        .safety-num {
            font-family: 'Syne', sans-serif;
            font-size: 24px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 3px;
        }

        .safety-num.s { color: var(--safe); }
        .safety-num.c { color: var(--caution); }
        .safety-num.w { color: var(--warning); }
        .safety-num.d { color: var(--danger); }

        .safety-lbl {
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: var(--text-dim);
        }

        /* ============================================================
           FABs
        ============================================================ */
        .fab-group {
            position: fixed;
            right: 16px;
            bottom: 24px;
            z-index: 500;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .fab {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 19px;
            cursor: pointer;
            transition: transform 0.22s, box-shadow 0.22s;
            border: none;
            text-decoration: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.45);
        }

        .fab:hover { transform: scale(1.12); }

        .fab-wa  { background: #25D366; color: white; }
        .fab-ref { background: var(--primary); color: white; }
        .fab-loc { background: var(--panel); border: 1px solid var(--border); color: white; backdrop-filter: blur(10px); }

        /* ============================================================
           LANGUAGE
        ============================================================ */
        .lang-wrap {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 600;
        }

        .lang-sel {
            padding: 7px 13px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: white;
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            outline: none;
        }

        /* ============================================================
           INSTALL BANNER
        ============================================================ */
        .install-banner {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 700;
            background: linear-gradient(135deg, var(--primary), var(--primary-dk));
            color: white;
            padding: 13px 22px;
            border-radius: 30px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.18);
            display: none;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            max-width: 92vw;
        }

        .install-banner.show { display: flex; }

        .install-ok {
            background: white;
            color: var(--primary);
            border: none;
            padding: 7px 16px;
            border-radius: 20px;
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
        }

        .install-x {
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 16px;
            cursor: pointer;
        }

        /* ============================================================
           LEAFLET POPUP
        ============================================================ */
        .leaflet-popup-content-wrapper {
            border-radius: 14px !important;
            padding: 0 !important;
            overflow: hidden;
            box-shadow: 0 12px 40px rgba(0,0,0,0.4) !important;
        }

        .leaflet-popup-content {
            margin: 0 !important;
            width: 330px !important;
        }

        .leaflet-popup-tip-container  { display: none; }
        .leaflet-popup-close-button   {
            z-index: 10;
            color: white !important;
            font-size: 18px !important;
            top: 10px !important;
            right: 12px !important;
        }

        /* Popup content */
        .pu { font-family: 'DM Sans', sans-serif; }

        .pu-head {
            padding: 18px 20px 14px;
        }

        .pu-zone {
            font-family: 'Syne', sans-serif;
            font-size: 20px;
            font-weight: 800;
            color: white;
            letter-spacing: -0.3px;
            margin-bottom: 3px;
        }

        .pu-region {
            font-size: 12px;
            color: rgba(255,255,255,0.78);
        }

        .pu-body {
            padding: 16px 20px;
            background: white;
        }

        .pu-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 13px;
        }

        .pu-metric {
            background: #f4f7fb;
            border-radius: 10px;
            padding: 11px 10px;
            text-align: center;
        }

        .pu-mval {
            font-family: 'Syne', sans-serif;
            font-size: 22px;
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
        }

        .pu-mlbl {
            font-size: 11px;
            color: #888;
            margin-top: 3px;
        }

        .pu-weather {
            background: #eef5ff;
            border-radius: 10px;
            padding: 11px 14px;
            margin-bottom: 12px;
        }

        .pu-wrow {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #333;
            padding: 4px 0;
        }

        .pu-wrow b { color: var(--primary); }

        .pu-fish {
            background: #f0fff5;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 12px;
        }

        .pu-safety {
            border-radius: 10px;
            padding: 13px;
            text-align: center;
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            font-size: 15px;
            color: white;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .pu-recs { margin-bottom: 10px; }

        .pu-rec {
            font-size: 12px;
            color: #555;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
            line-height: 1.4;
        }

        .pu-rec:last-child { border: none; }

        .pu-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .pu-btn {
            flex: 1;
            padding: 9px;
            border-radius: 8px;
            border: none;
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            display: block;
            transition: opacity 0.2s;
        }

        .pu-btn:hover { opacity: 0.85; }

        .pu-btn-hist { background: var(--primary); color: white; }
        .pu-btn-wa   { background: #25D366; color: white; }

        /* ============================================================
           MARKERS
        ============================================================ */
        .mk-bubble { background: transparent; }

        .mk-inner {
            color: white;
            padding: 7px 11px;
            border-radius: 22px;
            font-family: 'Syne', sans-serif;
            font-weight: 800;
            font-size: 13px;
            border: 2.5px solid rgba(255,255,255,0.85);
            box-shadow: 0 4px 14px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.2;
            cursor: pointer;
            transition: transform 0.18s;
            min-width: 60px;
            text-align: center;
        }

        .mk-inner:hover { transform: scale(1.08) translateY(-2px); }
        .mk-val { font-size: 15px; }
        .mk-lbl { font-size: 9px; opacity: 0.88; font-family: 'DM Sans', sans-serif; font-weight: 500; }

        /* ============================================================
           RESPONSIVE
        ============================================================ */
        @media (max-width: 768px) {
            .left-panel {
                left: 10px;
                right: 10px;
                width: auto;
                top: 10px;
            }

            .stats-panel {
                left: 10px;
                right: 66px;
                min-width: auto;
                bottom: 16px;
            }

            .fab-group { right: 10px; bottom: 16px; }
            .fab       { width: 46px; height: 46px; font-size: 17px; }
            .brand-name { font-size: 17px; }
            .lang-wrap  { display: none; }

            .leaflet-popup-content { width: 290px !important; }

            .install-banner { bottom: 105px; font-size: 12px; }
        }

        @media (max-width: 400px) {
            .filter-card { display: none; }
        }
    </style>
</head>
<body>

<!-- ============================================================
     LOADING SCREEN
============================================================ -->
<div id="loadingScreen">
    <div class="ls-wave">üåä</div>
    <div class="ls-title">PecheurConnect</div>
    <div class="ls-sub">S√©curit√© Maritime ¬∑ S√©n√©gal üá∏üá≥</div>
    <div class="ls-bar-wrap">
        <div class="ls-bar"></div>
    </div>
    <div class="ls-status" id="lsStatus">Connexion aux capteurs oc√©aniques...</div>
</div>

<!-- ============================================================
     OFFLINE BAR
============================================================ -->
<div class="offline-bar" id="offlineBar">
    ‚ö†Ô∏è Hors connexion ‚Äî Donn√©es du cache affich√©es
</div>

<!-- ============================================================
     MAP
============================================================ -->
<div id="map"></div>

<!-- ============================================================
     LEFT PANEL
============================================================ -->
<div class="left-panel">

    <!-- Brand -->
    <div class="brand-card">
        <div class="brand-row">
            <span class="brand-name">üåä PecheurConnect</span>
            <span class="brand-v">v3.0</span>
        </div>
        <div class="brand-chips">
            <div class="chip">
                <div class="live-dot"></div>
                <span id="zoneCount">18 zones</span>
            </div>
            <div class="chip">üó∫Ô∏è <span id="regionCount">6 r√©gions</span></div>
            <div class="chip">üïê <span id="lastUpdate">--:--</span> UTC</div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-card">
        <a class="nav-item current" href="./index.html">
            <span class="nav-icon">üó∫Ô∏è</span>Carte
        </a>
        <a class="nav-item" href="./history.html">
            <span class="nav-icon">üìä</span>Historique
        </a>
        <a class="nav-item" href="./comparator.html">
            <span class="nav-icon">üéØ</span>Comparer
        </a>
        <a class="nav-item" href="./export.html">
            <span class="nav-icon">üìÑ</span>Export
        </a>
        <a class="nav-item" href="./alerts-settings.html">
            <span class="nav-icon">üîî</span>Alertes
        </a>
        <a class="nav-item" href="./admin.html">
            <span class="nav-icon">üèõÔ∏è</span>Admin
        </a>
        <a class="nav-item" href="./api/index.html">
            <span class="nav-icon">üîå</span>API
        </a>
        <a class="nav-item" href="https://wa.me/221777020818" target="_blank">
            <span class="nav-icon">üì±</span>SOS
        </a>
    </div>

    <!-- Filters -->
    <div class="filter-card">
        <div class="filter-label">Filtrer par r√©gion</div>
        <div class="filter-pills">
            <div class="pill active" data-region="all"         onclick="doFilter(this)">Tout</div>
            <div class="pill"        data-region="Nord"        onclick="doFilter(this)">Nord</div>
            <div class="pill"        data-region="Grande C√¥te" onclick="doFilter(this)">G.C√¥te</div>
            <div class="pill"        data-region="Dakar"       onclick="doFilter(this)">Dakar</div>
            <div class="pill"        data-region="Petite C√¥te" onclick="doFilter(this)">P.C√¥te</div>
            <div class="pill"        data-region="Sine Saloum" onclick="doFilter(this)">S.Saloum</div>
            <div class="pill"        data-region="Casamance"   onclick="doFilter(this)">Casamance</div>
        </div>
    </div>

    <!-- Search -->
    <div class="search-card">
        <span class="search-icon">üîç</span>
        <input
            type="text"
            id="searchInput"
            class="search-input"
            placeholder="Chercher une zone (ex: Rufisque)..."
            oninput="doSearch(this.value)"
            autocomplete="off"
        >
    </div>

</div>

<!-- ============================================================
     STATS PANEL
============================================================ -->
<div class="stats-panel">
    <div class="stats-update">
        <div class="live-dot"></div>
        <span class="stats-update-text" id="updateTime">Chargement...</span>
    </div>
    <div class="safety-row">
        <div class="safety-box">
            <div class="safety-num s" id="cntSafe">0</div>
            <div class="safety-lbl">S√ªr</div>
        </div>
        <div class="safety-box">
            <div class="safety-num c" id="cntCaution">0</div>
            <div class="safety-lbl">Vigilance</div>
        </div>
        <div class="safety-box">
            <div class="safety-num w" id="cntWarning">0</div>
            <div class="safety-lbl">Prudence</div>
        </div>
        <div class="safety-box">
            <div class="safety-num d" id="cntDanger">0</div>
            <div class="safety-lbl">Danger</div>
        </div>
    </div>
</div>

<!-- ============================================================
     FABs
============================================================ -->
<div class="fab-group">
    <a  class="fab fab-wa"  href="https://wa.me/221777020818" target="_blank" title="Contact / SOS">üì±</a>
    <button class="fab fab-ref" onclick="doRefresh()"  title="Actualiser">üîÑ</button>
    <button class="fab fab-loc" onclick="doLocate()"   title="Ma position">üìç</button>
</div>

<!-- ============================================================
     LANGUAGE SELECTOR
============================================================ -->
<div class="lang-wrap">
    <select class="lang-sel" id="langSel" onchange="changeLang(this.value)">
        <option value="fr">üá´üá∑ Fran√ßais</option>
        <option value="wo">üá∏üá≥ Wolof</option>
        <option value="en">üá¨üáß English</option>
    </select>
</div>

<!-- ============================================================
     INSTALL BANNER
============================================================ -->
<div class="install-banner" id="installBanner">
    <span>üì≤ Installer l'application</span>
    <button class="install-ok" onclick="doInstall()">Installer</button>
    <button class="install-x"  onclick="hideInstall()">‚úï</button>
</div>

<!-- ============================================================
     LIBS
============================================================ -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<!-- ============================================================
     APP SCRIPT
============================================================ -->
<script>
/* ================================================================
   STATE
================================================================ */
let map, clusterLayer;
let allZones   = [];
let markerMap  = {};
let activeCharts = {};
let userMarker = null;
let deferredPWA = null;

const LANG_LABELS = {
    fr: { safe:'S√õR',  caution:'VIGILANCE', warning:'PRUDENCE', danger:'DANGER' },
    wo: { safe:'BAAX', caution:'SEET',      warning:'B√ÄYYI',   danger:'√ëAX'    },
    en: { safe:'SAFE', caution:'CAUTION',   warning:'WARNING', danger:'DANGER' }
};

let currentLang = localStorage.getItem('pc_lang') || 'fr';

/* ================================================================
   BOOT
================================================================ */
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('langSel').value = currentLang;
    initMap();
    initPWA();
    initOffline();
    loadData();
});

/* ================================================================
   MAP INIT
================================================================ */
function initMap() {
    map = L.map('map', {
        center:         [14.6, -16.9],
        zoom:           7,
        zoomControl:    false,
        attributionControl: true
    });

    // Fond de carte sombre
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© <a href="https://openstreetmap.org">OpenStreetMap</a> ¬© <a href="https://carto.com">CARTO</a> | PecheurConnect v3.0',
        subdomains:  'abcd',
        maxZoom:     19
    }).addTo(map);

    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // Cluster
    clusterLayer = L.markerClusterGroup({
        maxClusterRadius: 55,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        iconCreateFunction: cluster => {
            const n = cluster.getChildCount();
            return L.divIcon({
                html: `<div style="
                    width:42px; height:42px; border-radius:50%;
                    background:linear-gradient(135deg,#0056b3,#003d7a);
                    border:2.5px solid rgba(255,255,255,0.85);
                    box-shadow:0 4px 14px rgba(0,0,0,0.5);
                    display:flex; align-items:center; justify-content:center;
                    font-family:Syne,sans-serif; font-weight:800; font-size:14px;
                    color:white;
                ">${n}</div>`,
                className: '',
                iconSize:   [42, 42],
                iconAnchor: [21, 21]
            });
        }
    });

    map.addLayer(clusterLayer);
}

/* ================================================================
   DATA LOADING
================================================================ */
async function loadData() {
    setLsStatus('Chargement des 18 zones...');

    try {
        const res = await fetch('./data.json?v=' + Date.now());
        if (!res.ok) throw new Error('HTTP ' + res.status);

        allZones = await res.json();
        setLsStatus('Affichage de la carte...');
        await sleep(350);

        renderMarkers(allZones);
        updateStats(allZones);
        updateChips(allZones);
        hideLoading();

    } catch (err) {
        console.warn('R√©seau indisponible, chargement cache:', err);
        setLsStatus('‚ö†Ô∏è Mode hors ligne...');
        await loadCache();
        hideLoading();
    }
}

async function loadCache() {
    try {
        if (!('caches' in window)) return;
        const cache = await caches.open('pc-data-v1');
        const res   = await cache.match('./data.json');
        if (!res) return;
        allZones = await res.json();
        renderMarkers(allZones);
        updateStats(allZones);
        updateChips(allZones);
    } catch (e) {
        console.warn('Cache indisponible:', e);
    }
}

async function doRefresh() {
    showLoading('Actualisation...');
    clusterLayer.clearLayers();
    markerMap = {};
    await loadData();
}

/* ================================================================
   RENDER MARKERS
================================================================ */
function renderMarkers(zones) {
    clusterLayer.clearLayers();
    markerMap = {};

    zones.forEach(z => {
        const color = z.color || '#00c853';

        const icon = L.divIcon({
            className: 'mk-bubble',
            html: `<div class="mk-inner" style="background:${color}">
                       <span class="mk-val">${z.v_now}m</span>
                       <span class="mk-lbl">VAGUES</span>
                   </div>`,
            iconSize:   [68, 46],
            iconAnchor: [34, 23]
        });

        const marker = L.marker([z.lat, z.lon], { icon });

        marker.bindPopup(buildPopup(z), {
            maxWidth:  360,
            className: 'pc-popup'
        });

        marker.on('popupopen',  () => maybeDrawForecast(z));
        marker.on('popupclose', destroyCharts);

        clusterLayer.addLayer(marker);
        markerMap[z.zone] = { marker, zone: z };
    });
}

/* ================================================================
   BUILD POPUP
================================================================ */
function buildPopup(z) {
    const label  = (LANG_LABELS[currentLang] || LANG_LABELS.fr)[z.safety_level] || z.safety_level.toUpperCase();
    const shareText = encodeURIComponent(
        'PecheurConnect üá∏üá≥\n' + z.zone + ' - ' + z.safety +
        '\nüåä ' + z.v_now + 'm | üå°Ô∏è ' + z.t_now + '¬∞C | üå¨Ô∏è ' + (z.wind_speed || 'N/A') + 'm/s' +
        '\nhttps://doundou969.github.io/sunu-blue-tech/'
    );

    const wSection = (z.weather_desc && z.weather_desc !== 'Non disponible') ? `
        <div class="pu-weather">
            <div class="pu-wrow"><span>‚òÅÔ∏è M√©t√©o</span>      <b>${z.weather_desc}</b></div>
            <div class="pu-wrow"><span>üëÅÔ∏è Visibilit√©</span> <b>${z.visibility   || 'N/A'} km</b></div>
            <div class="pu-wrow"><span>üíß Humidit√©</span>   <b>${z.humidity     || 'N/A'} %</b></div>
            <div class="pu-wrow"><span>üåßÔ∏è Pluie</span>      <b>${z.precipitation || 0} mm/h</b></div>
        </div>
    ` : '';

    const rSection = z.recommendations && z.recommendations.length ? `
        <div class="pu-recs">
            ${z.recommendations.slice(0, 3).map(r => `<div class="pu-rec">‚Üí ${r}</div>`).join('')}
        </div>
    ` : '';

    const fSection = z.forecast && z.forecast.length ? `
        <div style="margin-top:12px;">
            <div style="font-size:11px;font-weight:700;color:#0056b3;text-transform:uppercase;letter-spacing:.5px;margin-bottom:7px;">üìà Pr√©visions 24h</div>
            <canvas id="fc_${z.zone.replace(/\W/g,'_')}" height="75"></canvas>
        </div>
    ` : '';

    return `
        <div class="pu">
            <div class="pu-head" style="background:linear-gradient(135deg,${z.color},${darken(z.color)})">
                <div class="pu-zone">${z.zone}</div>
                <div class="pu-region">üìç ${z.region} ‚Äî ${z.description}</div>
            </div>
            <div class="pu-body">
                <div class="pu-metrics">
                    <div class="pu-metric">
                        <div class="pu-mval">${z.v_now}m</div>
                        <div class="pu-mlbl">üåä Vagues</div>
                    </div>
                    <div class="pu-metric">
                        <div class="pu-mval">${z.t_now}¬∞C</div>
                        <div class="pu-mlbl">üå°Ô∏è Temp√©rature</div>
                    </div>
                    <div class="pu-metric">
                        <div class="pu-mval">${z.c_now}m/s</div>
                        <div class="pu-mlbl">üß≠ Courant</div>
                    </div>
                    <div class="pu-metric">
                        <div class="pu-mval">${z.wind_speed || 'N/A'}</div>
                        <div class="pu-mlbl">üå¨Ô∏è Vent m/s</div>
                    </div>
                </div>
                ${wSection}
                <div class="pu-fish">${z.index}</div>
                <div class="pu-safety" style="background:${z.color}">${z.safety} ‚Äî ${label}</div>
                ${rSection}
                ${fSection}
                <div class="pu-actions">
                    <a class="pu-btn pu-btn-hist" href="./history.html">üìä Historique</a>
                    <a class="pu-btn pu-btn-wa" href="https://wa.me/?text=${shareText}" target="_blank">üì§ Partager</a>
                </div>
            </div>
        </div>
    `;
}

/* ================================================================
   FORECAST CHART
================================================================ */
function maybeDrawForecast(z) {
    if (!z.forecast || !z.forecast.length) return;

    setTimeout(() => {
        const id     = 'fc_' + z.zone.replace(/\W/g, '_');
        const canvas = document.getElementById(id);
        if (!canvas) return;

        if (activeCharts[id]) activeCharts[id].destroy();

        activeCharts[id] = new Chart(canvas, {
            type: 'line',
            data: {
                labels:   z.forecast.map(f => f.time),
                datasets: [{
                    data:            z.forecast.map(f => f.wave),
                    borderColor:     z.color || '#0056b3',
                    backgroundColor: (z.color || '#0056b3') + '22',
                    fill:        true,
                    tension:     0.4,
                    borderWidth: 2,
                    pointRadius: 2,
                    pointHoverRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { font: { size: 10 }, callback: v => v + 'm' },
                        grid:  { color: 'rgba(0,0,0,0.04)' }
                    },
                    x: {
                        ticks: { font: { size: 9 }, maxRotation: 0 },
                        grid:  { display: false }
                    }
                }
            }
        });
    }, 80);
}

function destroyCharts() {
    Object.values(activeCharts).forEach(c => c.destroy());
    activeCharts = {};
}

/* ================================================================
   STATS PANEL
================================================================ */
function updateStats(zones) {
    const c = l => zones.filter(z => z.safety_level === l).length;

    document.getElementById('cntSafe').textContent    = c('safe');
    document.getElementById('cntCaution').textContent = c('caution');
    document.getElementById('cntWarning').textContent = c('warning');
    document.getElementById('cntDanger').textContent  = c('danger');

    if (zones.length && zones[0].date) {
        document.getElementById('updateTime').textContent = 'Mis √† jour : ' + zones[0].date;
        const t = (zones[0].date.split(' ')[1] || '--:--');
        document.getElementById('lastUpdate').textContent = t;
    }
}

function updateChips(zones) {
    document.getElementById('zoneCount').textContent   = zones.length + ' zones';
    const regions = new Set(zones.map(z => z.region));
    document.getElementById('regionCount').textContent = regions.size + ' r√©gions';
}

/* ================================================================
   FILTER
================================================================ */
function doFilter(el) {
    document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
    el.classList.add('active');

    const region = el.dataset.region;

    if (region === 'all') {
        renderMarkers(allZones);
    } else {
        const filtered = allZones.filter(z => z.region === region);
        renderMarkers(filtered);
        if (filtered.length) {
            const bounds = L.latLngBounds(filtered.map(z => [z.lat, z.lon]));
            map.fitBounds(bounds, { padding: [70, 70], maxZoom: 11 });
        }
    }
}

/* ================================================================
   SEARCH
================================================================ */
function doSearch(query) {
    const q = (query || '').toLowerCase().trim();
    if (q.length < 2) return;

    const found = Object.values(markerMap).find(m =>
        m.zone.zone.toLowerCase().includes(q) ||
        m.zone.description.toLowerCase().includes(q)
    );

    if (found) {
        map.flyTo([found.zone.lat, found.zone.lon], 12, { duration: 1.4 });
        setTimeout(() => found.marker.openPopup(), 1500);
        document.getElementById('searchInput').value = '';
    }
}

/* ================================================================
   GEOLOCATION
================================================================ */
function doLocate() {
    if (!navigator.geolocation) { alert('G√©olocalisation non disponible'); return; }

    navigator.geolocation.getCurrentPosition(
        pos => {
            const { latitude: lat, longitude: lon } = pos.coords;
            if (userMarker) map.removeLayer(userMarker);

            userMarker = L.circleMarker([lat, lon], {
                radius: 10, color: '#00d4ff', fillColor: '#00d4ff',
                fillOpacity: 0.35, weight: 2
            }).addTo(map).bindPopup('üìç Votre position').openPopup();

            map.flyTo([lat, lon], 11, { duration: 1.5 });
        },
        () => alert('Impossible de r√©cup√©rer votre position')
    );
}

/* ================================================================
   LANGUAGE
================================================================ */
function changeLang(lang) {
    currentLang = lang;
    localStorage.setItem('pc_lang', lang);
    renderMarkers(allZones);
}

/* ================================================================
   PWA
================================================================ */
function initPWA() {
    window.addEventListener('beforeinstallprompt', e => {
        e.preventDefault();
        deferredPWA = e;
        document.getElementById('installBanner').classList.add('show');
    });

    window.addEventListener('appinstalled', () => {
        document.getElementById('installBanner').classList.remove('show');
        deferredPWA = null;
    });
}

function doInstall() {
    if (!deferredPWA) return;
    deferredPWA.prompt();
    deferredPWA.userChoice.then(() => {
        document.getElementById('installBanner').classList.remove('show');
        deferredPWA = null;
    });
}

function hideInstall() {
    document.getElementById('installBanner').classList.remove('show');
}

/* ================================================================
   OFFLINE
================================================================ */
function initOffline() {
    const bar = document.getElementById('offlineBar');
    window.addEventListener('offline', () => bar.classList.add('show'));
    window.addEventListener('online',  () => bar.classList.remove('show'));
    if (!navigator.onLine) bar.classList.add('show');
}

/* ================================================================
   SERVICE WORKER
================================================================ */
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('[SW] Registered'))
        .catch(e  => console.warn('[SW] Error:', e));
}

/* ================================================================
   LOADING HELPERS
================================================================ */
function setLsStatus(msg) {
    document.getElementById('lsStatus').textContent = msg;
}

function showLoading(msg) {
    const s = document.getElementById('loadingScreen');
    s.classList.remove('hide');
    s.style.opacity    = '1';
    s.style.visibility = 'visible';
    setLsStatus(msg || 'Chargement...');
}

function hideLoading() {
    document.getElementById('loadingScreen').classList.add('hide');
}

/* ================================================================
   UTILS
================================================================ */
function darken(hex) {
    if (!hex || hex.length < 7) return '#000';
    const n = parseInt(hex.replace('#',''), 16);
    const r = Math.max(0, (n >> 16)         - 45);
    const g = Math.max(0, ((n >> 8) & 0xff) - 45);
    const b = Math.max(0, (n & 0xff)         - 45);
    return '#' + [r,g,b].map(v => v.toString(16).padStart(2,'0')).join('');
}

function sleep(ms) {
    return new Promise(r => setTimeout(r, ms));
}
</script>

</body>
</html>
