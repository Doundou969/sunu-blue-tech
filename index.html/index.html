<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PecheurConnect - SÃ©curitÃ© & PÃªche</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="manifest" href="./manifest.json">
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        .marker-label { color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold; border: 2px solid white; display: flex; align-items: center; gap: 5px; font-size: 13px; }
    </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([14.4974, -14.4524], 7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    fetch('./data.json').then(res => res.json()).then(data => {
        data.forEach((zone, i) => {
            const color = zone.vhm0 >= 2.2 ? '#d63031' : '#27ae60';
            const popupContent = `
                <div style="text-align: center; width: 220px;">
                    <h3>${zone.zone}</h3>
                    <b>Vagues : ${zone.vhm0}m</b> | <b>Temp : ${zone.temp}Â°C</b><br>
                    <canvas id="chart-${i}" style="height:120px;"></canvas>
                </div>`;

            const m = L.marker([zone.lat, zone.lon], {
                icon: L.divIcon({ className:'custom', html:`<div class="marker-label" style="background:${color}">${zone.vhm0}m ${zone.temp <= 22 ? 'ðŸŸ' : ''}</div>`, iconSize:[70,30] })
            }).addTo(map).bindPopup(popupContent);

            m.on('popupopen', () => {
                const ctx = document.getElementById(`chart-${i}`).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: zone.history.dates.map(d => d.slice(5)),
                        datasets: [{ label:'Temp', data: zone.history.values, borderColor:'#3498db', fill:true, tension:0.3 }]
                    },
                    options: { plugins: { legend: { display: false } } }
                });
            });
        });
    });

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(err => console.error(err));
    }
</script>
</body>
</html>
