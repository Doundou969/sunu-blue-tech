<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PecheurConnect PRO üá∏üá≥</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root { 
            --primary: #0056b3; 
            --danger: #d9534f; 
            --safe: #28a745; 
            --dark: #2c3e50;
            --panel: rgba(255, 255, 255, 0.9);
            --whatsapp: #25D366;
            --text: #333;
        }

        /* Mode Nuit Automatique pour prot√©ger les yeux en mer */
        @media (prefers-color-scheme: dark) {
            :root { 
                --panel: rgba(30, 30, 30, 0.95);
                --text: #f0f0f0;
                --dark: #ffffff;
            }
        }

        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; background: #1a1a1a; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* Interface du haut */
        .top-ui {
            position: absolute; top: 15px; left: 15px; right: 15px; z-index: 1000;
            max-width: 450px;
        }
        .brand-card {
            background: var(--panel); padding: 12px 20px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex;
            justify-content: space-between; align-items: center;
            border-bottom: 4px solid var(--primary); color: var(--text);
        }
        .brand-card h1 { margin: 0; font-size: 18px; font-weight: 900; }

        /* S√©lecteur de jours (Pr√©visions) */
        .forecast-bar {
            margin-top: 10px; display: flex; gap: 5px; 
            background: var(--panel); padding: 5px; border-radius: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .day-btn {
            flex: 1; border: none; padding: 10px; border-radius: 20px;
            cursor: pointer; background: transparent; color: var(--text);
            font-weight: bold; font-size: 12px; transition: 0.3s;
        }
        .day-btn.active { background: var(--primary); color: white; }

        /* Barre de recherche */
        .search-box {
            width: 100%; margin-top: 10px; padding: 12px 20px;
            border-radius: 25px; border: none; background: var(--panel);
            color: var(--text); box-shadow: 0 4px 10px rgba(0,0,0,0.2); outline: none;
        }

        /* Infos L√©gende */
        .legend-panel {
            position: absolute; bottom: 30px; left: 15px; z-index: 1000;
            background: var(--panel); padding: 12px; border-radius: 12px;
            font-size: 11px; color: var(--text); box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* Bouton WhatsApp */
        .whatsapp-float {
            position: absolute; bottom: 30px; right: 20px; z-index: 1000;
            background: var(--whatsapp); color: white; width: 60px; height: 60px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4); cursor: pointer;
        }

        /* Badge de vagues */
        .wave-label {
            color: white; padding: 4px 8px; border-radius: 12px;
            font-weight: bold; font-size: 12px; border: 2px solid white;
            text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }

        .fuel-info {
            background: rgba(0,0,0,0.05); padding: 8px; border-radius: 6px;
            margin-top: 8px; font-size: 11px; border-left: 3px solid #f39c12;
        }
    </style>
</head>
<body>

    <div class="top-ui">
        <div class="brand-card">
            <h1>üá∏üá≥ PecheurConnect PRO</h1>
            <span id="update-time" style="font-size:10px; opacity:0.8;">M√†J: --:--</span>
        </div>

        <div class="forecast-bar">
            <button class="day-btn active" onclick="updateDay(0)">Aujourd'hui</button>
            <button class="day-btn" onclick="updateDay(1)">Demain</button>
            <button class="day-btn" onclick="updateDay(2)">J+2</button>
        </div>

        <input type="text" id="zoneSearch" class="search-box" placeholder="üîç Rechercher un port...">
    </div>

    <div class="legend-panel">
        <b style="color:var(--primary)">UPWELLING (ZONE DE P√äCHE)</b><br>
        <span style="color:#003399">‚ñ†</span> Froid (Poisson +++) | <span style="color:#ffcc00">‚ñ†</span> Chaud (Poisson -)<br>
        <hr style="opacity:0.2">
        <b>S√âCURIT√â :</b> <span style="color:var(--safe)">‚óè</span> OK | <span style="color:var(--danger)">‚óè</span> DANGER
    </div>

    <div class="whatsapp-float" onclick="sendWhatsApp()">
        <svg width="30" height="30" fill="white" viewBox="0 0 24 24"><path d="M12.031 6.172c-2.32 0-4.591 1.342-5.467 3.398-.19.447-.442 1.397-.442 2.43 0 1.258.423 2.185.834 2.893l-.75 2.15 2.222-.72c.607.35 1.417.618 2.204.618 2.32 0 4.59-1.342 5.466-3.397.876-2.056.463-4.11-.96-5.353-.96-.842-1.802-1.02-3.107-1.02zm-2.015 7.15c-.18 0-.324-.045-.434-.135s-.166-.215-.166-.374c0-.158.056-.285.166-.38s.255-.143.434-.143c.18 0 .324.048.434.143s.166.222.166.38c0 .16-.056.284-.166.374s-.255.135-.434.135zm2.844 0c-.18 0-.324-.045-.434-.135s-.166-.215-.166-.374c0-.158.056-.285.166-.38s.255-.143.434-.143c.18 0 .324.048.434.143s.166.222.166.38c0 .16-.056.284-.166.374s-.255.135-.434.135z"/></svg>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentDay = 0;
        let marineData = [];
        const markers = [];
        const map = L.map('map', { zoomControl: false }).setView([14.45, -17.2], 7);
        const dataLayer = L.layerGroup().addTo(map);

        // Fond de carte sombre pour la navigation
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        async function fetchData() {
            try {
                const response = await fetch('./data.json?v=' + Date.now());
                marineData = await response.json();
                document.getElementById('update-time').innerText = "M√†J: " + marineData[0].date_update;
                renderScene();
            } catch (e) { console.error("Erreur de donn√©es"); }
        }

        function renderScene() {
            dataLayer.clearLayers();
            marineData.forEach(item => {
                const forecast = item.forecasts[currentDay];
                const isDanger = forecast.safety.includes("üî¥");
                const color = isDanger ? "#d9534f" : "#28a745";
                
                // 1. Couche Upwelling (Thermique)
                let tempColor = "#ffcc00"; // Chaud
                if (forecast.t_now < 23) tempColor = "#003399"; // Froid riche
                else if (forecast.t_now < 25) tempColor = "#3399ff";

                L.circle([item.lat, item.lon], {
                    radius: 35000, color: tempColor, fillOpacity: 0.15, weight: 1
                }).addTo(dataLayer);

                // 2. Marqueurs Vagues
                const marker = L.marker([item.lat, item.lon], {
                    icon: L.divIcon({
                        className: 'wave-icon',
                        html: `<div class="wave-label" style="background:${color}">${forecast.v_now}m</div>`,
                        iconSize: [60, 30]
                    })
                }).addTo(dataLayer);

                // 3. Calculateur de Carburant (Est.)
                const fuel = 15 + (forecast.v_now * 4) + (forecast.c_now * 10);

                marker.bindPopup(`
                    <div style="min-width:180px; color:#333">
                        <h3 style="margin:0">üìç ${item.zone}</h3>
                        <small>${forecast.jour}</small><hr>
                        üåä Vagues : <b>${forecast.v_now}m</b><br>
                        üå°Ô∏è Mer : <b>${forecast.t_now}¬∞C</b> (Upwelling)<br>
                        üêü P√™che : <b>${forecast.index}</b><br>
                        <div class="fuel-info">
                            ‚õΩ Est. Carburant : <b>~${fuel.toFixed(1)}L</b><br>
                            <span style="font-size:9px">Calcul√© selon vagues & courants</span>
                        </div>
                        <div style="margin-top:8px; padding:5px; background:${color}; color:white; text-align:center; border-radius:4px; font-weight:bold;">
                            ${forecast.safety}
                        </div>
                    </div>
                `);
                
                markers.push({ name: item.zone.toLowerCase(), latlng: [item.lat, item.lon], marker: marker });
            });
        }

        function updateDay(day) {
            currentDay = day;
            document.querySelectorAll('.day-btn').forEach((b, i) => b.classList.toggle('active', i === day));
            renderScene();
        }

        function sendWhatsApp() {
            const msg = encodeURIComponent("üì¢ *SIGNALEMENT PECHEURCONNECT*\nJe signale un changement au quai de p√™che...");
            window.open(`https://wa.me/221777020818?text=${msg}`, '_blank');
        }

        // Recherche
        document.getElementById('zoneSearch').addEventListener('input', (e) => {
            const s = e.target.value.toLowerCase();
            const f = markers.find(m => m.name.includes(s));
            if(f && s.length > 2) { map.flyTo(f.latlng, 10); f.marker.openPopup(); }
        });

        fetchData();
    </script>
</body>
</html>
