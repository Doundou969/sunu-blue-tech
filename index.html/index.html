<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PecheurConnect - SÃ©curitÃ© & Historique</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        .popup-chart { width: 250px; height: 150px; }
    </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([14.4974, -14.4524], 7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    fetch('data.json').then(res => res.json()).then(data => {
        data.forEach((zone, index) => {
            const color = zone.vhm0 >= 2.2 ? '#d63031' : '#27ae60';
            const fishMarker = zone.temp <= 22 ? 'ðŸŸ' : '';

            const canvasId = `chart-${index}`;
            const content = `
                <div style="text-align: center;">
                    <h3>${zone.zone} ${fishMarker}</h3>
                    <b>${zone.vhm0}m</b> | <b>${zone.temp}Â°C</b><br>
                    <small>${zone.temp_trend}</small>
                    <canvas id="${canvasId}" class="popup-chart"></canvas>
                </div>
            `;

            const marker = L.marker([zone.lat, zone.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background:${color}; color:white; padding:5px; border-radius:10px; border:2px solid white; font-weight:bold;">${zone.vhm0}m</div>`,
                    iconSize: [50, 30]
                })
            }).addTo(map).bindPopup(content);

            // GÃ©nÃ©rer le graphique quand on ouvre le popup
            marker.on('popupopen', () => {
                const ctx = document.getElementById(canvasId).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: zone.history.dates,
                        datasets: [{
                            label: 'Temp Â°C',
                            data: zone.history.values,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            fill: true,
                            tension: 0.3
                        }]
                    },
                    options: { 
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: false } }
                    }
                });
            });
        });
    });
</script>
</body>
</html>
