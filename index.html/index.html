<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PecheurConnect - Intelligence Marine</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin:0; font-family:sans-serif; } #map { height:100vh; }
        .marker-label { color:white; padding:5px 10px; border-radius:15px; font-weight:bold; border:2px solid white; display:flex; align-items:center; gap:5px; font-size:13px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .box { background:#f4f4f4; padding:8px; margin:5px 0; border-radius:5px; border-left:4px solid #ccc; text-align:left; font-size: 12px; }
        .badge-fish { background: #2ecc71; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; float: right; }
    </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([14.5, -17.2], 7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    fetch('./data.json?v=' + Date.now()).then(r => r.json()).then(data => {
        data.forEach((z, i) => {
            // Mapping des nouvelles donn√©es Copernicus
            const vNow = z.v_now || z.vagues || 0;
            const tNow = z.t_now || z.temp_mer || 0;
            const chl = z.chlorophylle || 0;
            const current = z.courant_ms || 0;
            const fishIndex = z.indice_poisson || "MOYEN";
            const safety = z.securite || "S√õR";
            
            // Historique pour le graphique
            const hDat = z.h_dat || [];
            const hVal = z.h_val || [];

            // Couleur selon s√©curit√©
            const color = safety === "DANGER" ? '#e74c3c' : '#2ecc71';
            
            const popup = `
                <div style="width:220px">
                    <h3 style="text-align:center; margin-bottom:5px;">${z.zone}</h3>
                    <div class="box" style="border-left-color: #3498db">
                        <b>üåä √âtat de la mer</b><br>
                        Vagues : ${vNow}m | Courant : ${current}m/s
                    </div>
                    <div class="box" style="border-left-color: #2ecc71">
                        <span class="badge-fish">${fishIndex}</span>
                        <b>üêü Potentiel P√™che</b><br>
                        Temp : ${tNow}¬∞C | Chl : ${chl}
                    </div>
                    <div class="box" style="border-left-color:${color}">
                        <b>üõ°Ô∏è S√©curit√© : ${safety}</b>
                    </div>
                    ${hDat.length > 0 ? `<canvas id="chart-${i}" height="100"></canvas>` : ''}
                </div>`;

            // Label sur la carte : affiche Vagues + Ic√¥ne Poisson si l'indice est √âlev√©
            const markerHtml = `
                <div class="marker-label" style="background:${color}">
                    ${vNow}m ${fishIndex === '√âLEV√â' ? 'üêü' : ''}
                </div>`;

            const m = L.marker([z.lat, z.lon], {
                icon: L.divIcon({ html: markerHtml, iconSize: [85, 30] })
            }).addTo(map).bindPopup(popup);

            // Graphique de tendance
            m.on('popupopen', () => {
                const canvas = document.getElementById(`chart-${i}`);
                if (!canvas || hDat.length === 0) return;

                new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: hDat.map(d => d.slice(8,10)),
                        datasets: [{ label:'Temp', data:hVal, borderColor:'#3498db', backgroundColor:'rgba(52, 152, 219, 0.1)', tension:0.3, fill:true }]
                    },
                    options: { plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
                });
            });
        });
    }).catch(err => console.error("Erreur chargement JSON:", err));
</script>
</body>
</html>
