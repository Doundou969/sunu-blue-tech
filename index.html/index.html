<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PecheurConnect</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; }
        .marker-label { color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold; border: 2px solid white; display:flex; align-items:center; gap:5px; }
        .popup-card { text-align: center; width: 220px; }
        .box { background: #f4f4f4; padding: 8px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #ccc; }
    </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([14.5, -17.0], 7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    // Ajout d'un param√®tre al√©atoire pour forcer la mise √† jour des donn√©es (√©vite le cache)
    fetch('./data.json?nocache=' + Math.random()).then(r => r.json()).then(data => {
        data.forEach((z, i) => {
            const color = z.vhm0 >= 2.1 ? '#e74c3c' : '#2ecc71';
            const alertColor = z.tomorrow_wave >= 2.1 ? '#e74c3c' : '#2ecc71';
            
            const popup = `
                <div class="popup-card">
                    <h3>${z.zone}</h3>
                    <div class="box"><b>Aujourd'hui:</b> ${z.vhm0}m | ${z.temp}¬∞C</div>
                    <div class="box" style="border-left-color:${alertColor}">
                        <b>Demain:</b> ${z.tomorrow_wave}m ${z.tomorrow_wave >= 2.1 ? '‚ö†Ô∏è' : '‚úÖ'}
                    </div>
                    <canvas id="chart-${i}" height="100"></canvas>
                </div>`;

            const m = L.marker([z.lat, z.lon], {
                icon: L.divIcon({ html: `<div class="marker-label" style="background:${color}">${z.vhm0}m ${z.temp <= 22 ? 'üêü' : ''}</div>`, iconSize: [80, 30] })
            }).addTo(map).bindPopup(popup);

            m.on('popupopen', () => {
                const ctx = document.getElementById(`chart-${i}`).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: z.history.dates.map(d => d.slice(8,10)),
                        datasets: [{ label: 'Temp', data: z.history.values, borderColor: '#3498db', tension: 0.3 }]
                    },
                    options: { plugins: { legend: { display: false } } }
                });
            });
        });
    });
</script>
</body>
</html>
