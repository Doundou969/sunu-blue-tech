<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PecheurConnect PRO ğŸ‡¸ğŸ‡³</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #0056b3; --danger: #d9534f; --safe: #28a745; --panel: rgba(255, 255, 255, 0.9); --text: #333; --whatsapp: #25D366; }
        @media (prefers-color-scheme: dark) { :root { --panel: rgba(30, 30, 30, 0.95); --text: #f0f0f0; } }
        body { margin: 0; font-family: sans-serif; background: #1a1a1a; color: var(--text); }
        #map { height: 100vh; width: 100%; }
        .top-ui { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 1000; max-width: 400px; }
        .brand-card { background: var(--panel); padding: 12px; border-radius: 12px; display: flex; justify-content: space-between; border-bottom: 4px solid var(--primary); }
        .forecast-bar { margin-top: 10px; display: flex; gap: 5px; background: var(--panel); padding: 5px; border-radius: 25px; }
        .day-btn { flex: 1; border: none; padding: 10px; border-radius: 20px; cursor: pointer; background: transparent; color: var(--text); font-weight: bold; }
        .day-btn.active { background: var(--primary); color: white; }
        .search-box { width: 100%; margin-top: 10px; padding: 12px; border-radius: 25px; border: none; background: var(--panel); color: var(--text); outline: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .whatsapp-btn { position: absolute; bottom: 30px; right: 20px; z-index: 1000; background: var(--whatsapp); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .wave-label { color: white; padding: 4px 8px; border-radius: 10px; font-weight: bold; border: 2px solid white; }
    </style>
</head>
<body>
    <div class="top-ui">
        <div class="brand-card"><h1>ğŸ‡¸ğŸ‡³ PecheurConnect</h1><span id="update-time">--:--</span></div>
        <div class="forecast-bar">
            <button class="day-btn active" onclick="updateDay(0)">Aujourd'hui</button>
            <button class="day-btn" onclick="updateDay(1)">Demain</button>
            <button class="day-btn" onclick="updateDay(2)">J+2</button>
        </div>
        <input type="text" id="zoneSearch" class="search-box" placeholder="ğŸ” Chercher un port...">
    </div>
    <div id="map"></div>
    <div class="whatsapp-btn" onclick="window.open('https://wa.me/221777020818')">ğŸ’¬</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentDay = 0;
        let marineData = [];
        let markers = [];
        const map = L.map('map', { zoomControl: false }).setView([14.45, -17.2], 7);
        const dataLayer = L.layerGroup().addTo(map);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        async function fetchData() {
            try {
                const r = await fetch('data.json?v=' + Date.now());
                if(!r.ok) throw new Error("Fichier data.json absent");
                marineData = await r.json();
                document.getElementById('update-time').innerText = "MÃ J: " + marineData[0].date_update;
                renderScene();
            } catch (e) { console.error(e); }
        }

        function renderScene() {
            dataLayer.clearLayers();
            markers = [];
            marineData.forEach(item => {
                const f = item.forecasts[currentDay];
                const color = f.safety.includes("ğŸ”´") ? "#d9534f" : "#28a745";
                
                // Upwelling
                L.circle([item.lat, item.lon], { radius: 30000, color: (f.t_now < 23 ? "#003399" : "#ffcc00"), fillOpacity: 0.2 }).addTo(dataLayer);

                const marker = L.marker([item.lat, item.lon], {
                    icon: L.divIcon({ className: 'custom', html: `<div class="wave-label" style="background:${color}">${f.v_now}m</div>` })
                }).addTo(dataLayer);

                marker.bindPopup(`<b>ğŸ“ ${item.zone}</b><br>Vagues: ${f.v_now}m<br>Mer: ${f.t_now}Â°C<br>PÃªche: ${f.index}<br><b>${f.safety}</b>`);
                markers.push({ name: item.zone.toLowerCase(), latlng: [item.lat, item.lon], marker: marker });
            });
        }

        function updateDay(d) {
            currentDay = d;
            document.querySelectorAll('.day-btn').forEach((b, i) => b.classList.toggle('active', i === d));
            renderScene();
        }

        document.getElementById('zoneSearch').addEventListener('input', (e) => {
            const s = e.target.value.toLowerCase();
            const f = markers.find(m => m.name.includes(s));
            if(f && s.length > 2) { map.flyTo(f.latlng, 10); f.marker.openPopup(); }
        });

        fetchData();
    </script>
</body>
</html>
