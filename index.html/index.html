<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PecheurConnect ğŸ‡¸ğŸ‡³</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./icon-192.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { background:#020617; color:white; font-family: sans-serif; }
        #map { height:350px; border-radius:16px; border: 1px solid #1e293b; }
        .danger-card { border-left: 4px solid #ef4444; }
        .safe-card { border-left: 4px solid #06b6d4; }
    </style>
</head>
<body class="p-4 max-w-4xl mx-auto">

    <header class="text-center mb-6">
        <h1 class="text-3xl font-black text-sky-400">PECHEUR CONNECT ğŸ‡¸ğŸ‡³</h1>
        <p class="text-slate-400 text-sm italic">SystÃ¨me de surveillance SunuBlueTech par Copernicus</p>
    </header>

    <div id="map" class="mb-6 shadow-2xl"></div>

    <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        </div>

    <script>
        // PWA Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register("./sw.js").catch(() => {});
        }

        // Init Map (CentrÃ©e sur le SÃ©nÃ©gal)
        const map = L.map('map').setView([14.497, -16.5], 7);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        }).addTo(map);

        // Fetch Data
        fetch("./data.json?t=" + Date.now())
            .then(r => r.json())
            .then(data => {
                const dash = document.getElementById("dashboard");
                dash.innerHTML = "";

                data.forEach(z => {
                    const isDanger = z.vhm0 >= 2.2;
                    const statusColor = isDanger ? "text-red-500" : "text-cyan-400";
                    
                    // 1. Ajout de la Carte HTML
                    const div = document.createElement("div");
                    div.className = `p-4 bg-slate-800/50 rounded-xl shadow-md border border-slate-700 ${isDanger ? 'danger-card' : 'safe-card'}`;
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <b class="text-lg">${z.zone}</b>
                            <span class="text-xs px-2 py-1 rounded bg-slate-900 font-bold ${statusColor}">${z.alert}</span>
                        </div>
                        <div class="text-sm grid grid-cols-2 gap-2">
                            <div>ğŸŒŠ Houle: <span class="font-bold text-white">${z.vhm0}m</span></div>
                            <div>ğŸŒ¡ï¸ Mer: <span class="font-bold text-white">${z.temp}Â°C</span></div>
                            <div>ğŸ’¨ Vent: <span class="font-bold text-white">${z.wind_speed}km/h</span></div>
                            <div>ğŸ§­ Dir: <span class="font-bold text-white">${z.wind_dir}</span></div>
                        </div>
                    `;
                    dash.appendChild(div);

                    // 2. Ajout du Marqueur sur la carte
                    if (z.lat && z.lon) {
                        const markerColor = isDanger ? "#ef4444" : "#22d3ee";
                        const marker = L.circleMarker([z.lat, z.lon], {
                            radius: 12,
                            color: "#fff",
                            weight: 2,
                            fillColor: markerColor,
                            fillOpacity: 0.9
                        }).addTo(map);

                        // Popup interactive
                        marker.bindPopup(`
                            <div style="color:#000">
                                <b>${z.zone}</b><br>
                                Houle: ${z.vhm0}m<br>
                                <b>${z.alert}</b>
                            </div>
                        `);
                    }
                });
            })
            .catch(err => {
                document.getElementById("dashboard").innerHTML = "<p class='text-center text-red-400'>Erreur de chargement des donnÃ©es...</p>";
            });
    </script>
</body>
</html>
