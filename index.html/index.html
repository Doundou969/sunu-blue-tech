<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PecheurConnect</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin:0; font-family:sans-serif; background:#f0f2f5; }
        #map { height:100vh; width:100%; }
        .marker-label { color:white; padding:5px 10px; border-radius:15px; font-weight:bold; border:2px solid white; display:flex; align-items:center; gap:5px; font-size:13px; box-shadow:0 2px 4px rgba(0,0,0,0.2); }
        .popup-card { width:200px; text-align:center; }
        .box { background:#fff; padding:8px; margin:5px 0; border-radius:8px; border:1px solid #ddd; border-left:5px solid #ccc; }
    </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([14.5, -17.2], 7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    // Chargement des donn√©es avec for√ßage de mise √† jour (Date.now())
    fetch('./data.json?v=' + Date.now()).then(r => r.json()).then(data => {
        data.forEach((z, i) => {
            const color = z.v_now >= 2.1 ? '#e74c3c' : '#2ecc71';
            const alertColor = z.w_tomorrow >= 2.1 ? '#e74c3c' : '#2ecc71';
            
            const popup = `
                <div class="popup-card">
                    <h3 style="margin:5px">${z.zone}</h3>
                    <div class="box"><b>Aujourd'hui</b><br>üåä ${z.v_now}m | üå°Ô∏è ${z.t_now}¬∞C</div>
                    <div class="box" style="border-left-color:${alertColor}">
                        <b>Demain (Pr√©vision)</b><br>üåä ${z.w_tomorrow}m ${z.w_tomorrow >= 2.1 ? '‚ö†Ô∏è' : '‚úÖ'}
                    </div>
                    <canvas id="chart-${i}" height="100"></canvas>
                </div>`;

            L.marker([z.lat, z.lon], {
                icon: L.divIcon({ html: `<div class="marker-label" style="background:${color}">${z.v_now}m ${z.t_now <= 22 ? 'üêü' : ''}</div>`, iconSize: [85, 30] })
            }).addTo(map).bindPopup(popup).on('popupopen', () => {
                const ctx = document.getElementById(`chart-${i}`).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: z.h_dat.map(d => d.slice(8,10) + '/' + d.slice(5,7)),
                        datasets: [{ label:'Temp', data:z.h_val, borderColor:'#3498db', tension:0.3, fill:true, backgroundColor:'rgba(52,152,219,0.1)' }]
                    },
                    options: { plugins:{legend:{display:false}}, scales:{y:{beginAtZero:false}} }
                });
            });
        });
    });
</script>
</body>
</html>
