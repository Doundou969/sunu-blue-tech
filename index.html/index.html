<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PecheurConnect</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin:0; font-family:sans-serif; } #map { height:100vh; }
        .marker-label { color:white; padding:5px 10px; border-radius:15px; font-weight:bold; border:2px solid white; display:flex; align-items:center; gap:5px; font-size:13px; }
        .box { background:#f4f4f4; padding:8px; margin:5px 0; border-radius:5px; border-left:4px solid #ccc; text-align:center; }
    </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([14.5, -17.2], 7);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);

    fetch('./data.json?v=' + Date.now()).then(r => r.json()).then(data => {
        data.forEach((z, i) => {
            // S√âCURIT√â : On v√©rifie si les donn√©es existent, sinon on met des valeurs par d√©faut
            const vNow = z.v_now || z.vhm0 || 0;
            const tNow = z.t_now || z.temp || 0;
            const wTom = z.w_tomorrow || 0;
            const hDat = z.h_dat || (z.history ? z.history.dates : []);
            const hVal = z.h_val || (z.history ? z.history.values : []);

            const color = vNow >= 2.1 ? '#e74c3c' : '#2ecc71';
            
            const popup = `
                <div style="width:200px">
                    <h3 style="text-align:center">${z.zone}</h3>
                    <div class="box"><b>Aujourd'hui</b><br>üåä ${vNow}m | üå°Ô∏è ${tNow}¬∞C</div>
                    <div class="box" style="border-left-color:${wTom >= 2.1 ? '#e74c3c' : '#2ecc71'}">
                        <b>Demain</b><br>üåä ${wTom}m ${wTom >= 2.1 ? '‚ö†Ô∏è' : '‚úÖ'}
                    </div>
                    ${hDat.length > 0 ? `<canvas id="chart-${i}" height="100"></canvas>` : '<p style="font-size:10px">Graphique indisponible</p>'}
                </div>`;

            const m = L.marker([z.lat, z.lon], {
                icon: L.divIcon({ html: `<div class="marker-label" style="background:${color}">${vNow}m ${tNow <= 22 ? 'üêü' : ''}</div>`, iconSize: [85, 30] })
            }).addTo(map).bindPopup(popup);

            m.on('popupopen', () => {
                const canvas = document.getElementById(`chart-${i}`);
                if (!canvas || hDat.length === 0) return; // Emp√™che l'erreur .map()

                new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: hDat.map(d => d.slice(8,10)),
                        datasets: [{ label:'Temp', data:hVal, borderColor:'#3498db', tension:0.3, fill:true }]
                    },
                    options: { plugins: { legend: { display: false } } }
                });
            });
        });
    }).catch(err => console.error("Erreur chargement JSON:", err));
</script>
</body>
</html>
