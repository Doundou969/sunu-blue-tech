<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PecheurConnect ğŸ‡¸ğŸ‡³</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { background:#020617; color:white; font-family: system-ui, sans-serif; }
        #map { height:350px; border-radius:16px; border: 1px solid #1e293b; z-index: 10; }
        .card-danger { border-left: 5px solid #ef4444; background: rgba(239, 68, 68, 0.1); }
        .card-ok { border-left: 5px solid #22d3ee; background: rgba(30, 41, 59, 0.5); }
    </style>
</head>

<body class="p-4 max-w-4xl mx-auto">

    <header class="text-center mb-6">
        <h1 class="text-3xl font-black text-sky-400">PECHEUR CONNECT ğŸ‡¸ğŸ‡³</h1>
        <p class="text-slate-400 text-xs uppercase tracking-widest mt-1">DonnÃ©es Copernicus en Temps RÃ©el</p>
    </header>

    <div id="map" class="mb-6 shadow-2xl"></div>
    
    <div id="dashboard" class="grid gap-4 sm:grid-cols-2">
        </div>

    <script>
        // 1. Initialisation Carte
        const map = L.map('map').setView([14.5, -17.0], 7);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO'
        }).addTo(map);

        // 2. Chargement des donnÃ©es
        async function updateApp() {
            const dash = document.getElementById("dashboard");
            try {
                // Le "./" est crucial pour GitHub Pages
                const res = await fetch("./data.json?t=" + Date.now());
                if (!res.ok) throw new Error("Fichier data.json introuvable");
                
                const data = await res.json();
                dash.innerHTML = "";

                data.forEach(z => {
                    const isDanger = z.vhm0 >= 2.2;
                    const markerColor = isDanger ? "#ef4444" : "#22d3ee";

                    // CrÃ©ation Card
                    const div = document.createElement("div");
                    div.className = `p-4 rounded-xl shadow-lg border border-slate-700 ${isDanger ? 'card-danger' : 'card-ok'}`;
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <b class="text-lg">${z.zone}</b>
                            <span class="text-[10px] px-2 py-1 rounded font-bold ${isDanger ? 'bg-red-600' : 'bg-cyan-600'}">
                                ${z.alert}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 text-sm gap-2">
                            <div class="text-slate-400">ğŸŒŠ Houle</div><div class="text-right font-bold">${z.vhm0}m ${z.trend}</div>
                            <div class="text-slate-400">ğŸŒ¡ï¸ Mer</div><div class="text-right font-bold">${z.temp}Â°C</div>
                            <div class="text-slate-400">ğŸ’¨ Vent</div><div class="text-right font-bold">${z.wind_speed}km/h</div>
                        </div>
                    `;
                    dash.appendChild(div);

                    // Ajout Marqueur
                    if (z.lat && z.lon) {
                        L.circleMarker([z.lat, z.lon], {
                            radius: 12, color: "#fff", weight: 2, fillColor: markerColor, fillOpacity: 0.9
                        }).addTo(map).bindPopup(`<b>${z.zone}</b><br>Houle: ${z.vhm0}m`);
                    }
                });
            } catch (err) {
                dash.innerHTML = `<div class="col-span-full text-center p-10 bg-red-900/20 border border-red-500 rounded-xl">
                    <p class="font-bold">âš ï¸ Erreur de donnÃ©es</p>
                    <p class="text-xs text-slate-400 mt-2 italic">VÃ©rifiez que data.json est Ã  la racine et n'utilisez pas de "/" aprÃ¨s index.html</p>
                </div>`;
            }
        }

        updateApp();

        // 3. Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register("sw.js").catch(() => {});
        }
    </script>
</body>
</html>
