<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PecheurConnect üá∏üá≥</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { background:#020617; color:white; font-family: sans-serif; }
        #map { height:350px; border-radius:16px; border: 2px solid #1e293b; z-index: 1; }
        .zone-card { transition: transform 0.2s; border-left-width: 6px; }
        .zone-card:hover { transform: translateY(-2px); }
        /* Correction pour les popups Leaflet */
        .leaflet-popup-content-wrapper { background: #1e293b; color: white; border: 1px solid #334155; }
        .leaflet-popup-tip { background: #1e293b; }
    </style>
</head>

<body class="p-4 max-w-4xl mx-auto">

    <header class="text-center mb-6">
        <h1 class="text-3xl font-black text-sky-400 tracking-tighter">PECHEUR CONNECT üá∏üá≥</h1>
        <p class="text-slate-400 text-[10px] uppercase tracking-[0.2em] mt-1">Surveillance Maritime & S√©curit√©</p>
    </header>

    <div id="map" class="mb-6 shadow-2xl shadow-blue-900/20"></div>
    
    <div id="dashboard" class="grid gap-4 sm:grid-cols-2">
        <div class="col-span-full text-center py-10 text-slate-500 italic text-sm">
            Chargement des donn√©es Copernicus...
        </div>
    </div>

    <footer class="mt-10 mb-6 text-center text-[10px] text-slate-600 border-t border-slate-800 pt-4">
        &copy; 2026 PecheurConnect - Donn√©es via Copernicus Marine Service
    </footer>

    <script>
        // 1. Initialisation de la carte (Centr√©e S√©n√©gal)
        const map = L.map('map').setView([14.4, -17.0], 7);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO'
        }).addTo(map);

        // 2. Fonction de chargement des donn√©es
        async function loadData() {
            const dash = document.getElementById("dashboard");
            
            try {
                // Utilisation d'un chemin relatif strict pour √©viter les erreurs 404 GitHub
                const response = await fetch("data.json?v=" + Date.now());
                
                if (!response.ok) throw new Error("Fichier data.json introuvable");
                
                const data = await response.json();
                dash.innerHTML = ""; // Vider le message de chargement

                data.forEach(z => {
                    const isDanger = parseFloat(z.vhm0) >= 2.2;
                    const statusBg = isDanger ? 'bg-red-500/10' : 'bg-slate-800/50';
                    const borderColor = isDanger ? 'border-red-600' : 'border-cyan-600';
                    const textColor = isDanger ? 'text-red-500' : 'text-cyan-400';

                    // Cr√©ation de la carte HTML
                    const card = document.createElement("div");
                    card.className = `p-4 rounded-xl ${statusBg} border ${borderColor} zone-card shadow-lg`;
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-3">
                            <h2 class="font-bold text-lg tracking-tight">${z.zone}</h2>
                            <span class="text-[10px] font-black px-2 py-0.5 rounded ${isDanger ? 'bg-red-600 text-white' : 'bg-cyan-900 text-cyan-200'}">
                                ${z.alert}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-y-2 text-sm">
                            <div class="text-slate-400">üåä Houle</div>
                            <div class="text-right font-mono font-bold ${textColor}">${z.vhm0} m ${z.trend}</div>
                            <div class="text-slate-400">üå°Ô∏è Temp.</div>
                            <div class="text-right font-bold">${z.temp} ¬∞C</div>
                            <div class="text-slate-400">üí® Vent</div>
                            <div class="text-right font-bold text-xs">${z.wind_speed} km/h (${z.wind_dir})</div>
                        </div>
                        <div class="mt-4 text-[9px] text-slate-500 flex justify-between border-t border-slate-700/50 pt-2">
                            <span>Source: ${z.source}</span>
                            <span>${z.timestamp.split('T')[1].split('.')[0]} GMT</span>
                        </div>
                    `;
                    dash.appendChild(card);

                    // Ajout du marqueur sur la carte Leaflet
                    if (z.lat && z.lon) {
                        const marker = L.circleMarker([z.lat, z.lon], {
                            radius: 10,
                            color: "#fff",
                            weight: 1,
                            fillColor: isDanger ? "#ef4444" : "#06b6d4",
                            fillOpacity: 0.8
                        }).addTo(map);

                        marker.bindPopup(`
                            <div class="text-xs">
                                <b class="text-sm">${z.zone}</b><br>
                                <span class="${isDanger ? 'text-red-500' : 'text-cyan-400'}"><b>${z.alert}</b></span><br>
                                Houle: ${z.vhm0}m
                            </div>
                        `);
                    }
                });

            } catch (err) {
                console.error("Erreur PecheurConnect:", err);
                dash.innerHTML = `
                    <div class="col-span-full p-8 border-2 border-dashed border-red-900/50 rounded-2xl text-center bg-red-900/10">
                        <div class="text-3xl mb-2">‚ö†Ô∏è</div>
                        <p class="text-red-400 font-bold">Donn√©es Indisponibles</p>
                        <p class="text-[10px] text-slate-500 mt-2 italic">
                            V√©rifiez que "data.json" est bien √† la racine du d√©p√¥t GitHub et que l'URL ne contient pas de "/" apr√®s index.html
                        </p>
                    </div>
                `;
            }
        }

        // Lancement
        loadData();

        // Enregistrement Service Worker (PWA)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register("sw.js").catch(() => {});
        }
    </script>
</body>
</html>
