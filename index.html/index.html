<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PecheurConnect - S√©n√©gal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .marker-label { 
            color: white; padding: 5px 12px; border-radius: 20px; 
            font-weight: bold; border: 2px solid white; 
            display: flex; align-items: center; gap: 5px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-size: 14px; white-space: nowrap;
        }
        .popup-card { text-align: center; width: 240px; }
        .forecast-box { 
            background: #f8f9fa; border-radius: 8px; 
            padding: 10px; margin: 10px 0; border: 1px solid #eee;
        }
        .share-btn { 
            background: #25D366; color: white; border: none; 
            padding: 12px; border-radius: 8px; cursor: pointer; 
            width: 100%; font-weight: bold; margin-top: 5px;
        }
        .alert-text { color: #d63031; font-weight: bold; }
    </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([14.4974, -14.4524], 7);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '¬© PecheurConnect'
    }).addTo(map);

    function shareToWhatsApp(zone, now, next) {
        const msg = `üö¢ *PECHEURCONNECT - ${zone}*\nüåä Aujourd'hui: ${now}m\nüîÆ Demain: ${next}m\nüìç Ma Position: https://www.google.com/maps?q=${map.getCenter().lat},${map.getCenter().lng}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    }

    fetch('./data.json?v=' + Date.now()).then(r => r.json()).then(data => {
        data.forEach((z, i) => {
            // Couleur de la pastille (Aujourd'hui)
            const color = z.vhm0 >= 2.1 ? '#d63031' : '#27ae60';
            const fishIcon = z.temp <= 22 ? 'üêü' : '';
            const alertIcon = z.tomorrow_wave >= 2.1 ? '‚ö†Ô∏è' : '‚úÖ';

            const popupContent = `
                <div class="popup-card">
                    <h3 style="margin:5px 0">${z.zone}</h3>
                    <div class="forecast-box">
                        <small>AUJOURD'HUI</small><br>
                        <b>üåä ${z.vhm0}m</b> | üå°Ô∏è <b>${z.temp}¬∞C</b>
                    </div>
                    <div class="forecast-box" style="border-left: 4px solid ${z.tomorrow_wave >= 2.1 ? '#d63031' : '#27ae60'}">
                        <small>PR√âVISIONS DEMAIN</small><br>
                        <b>${alertIcon} Vagues : ${z.tomorrow_wave}m</b>
                    </div>
                    <canvas id="chart-${i}" height="100"></canvas>
                    <button class="share-btn" onclick="shareToWhatsApp('${z.zone}', ${z.vhm0}, ${z.tomorrow_wave})">
                        üì≤ Alerter sur WhatsApp
                    </button>
                </div>
            `;

            const marker = L.marker([z.lat, z.lon], {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="marker-label" style="background:${color}">${z.vhm0}m ${fishIcon}</div>`,
                    iconSize: [80, 35]
                })
            }).addTo(map).bindPopup(popupContent);

            marker.on('popupopen', () => {
                const ctx = document.getElementById(`chart-${i}`).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: z.history.dates.map(d => d.slice(8, 10) + '/' + d.slice(5, 7)),
                        datasets: [{
                            label: 'Temp√©rature (¬∞C)',
                            data: z.history.values,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: { 
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: false } }
                    }
                });
            });
        });
    });
</script>
</body>
</html>
