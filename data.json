import json
import datetime

# Charger les donnÃ©es
with open("data.json", "r") as f:
    data = json.load(f)

# PrÃ©parer le message
now = datetime.datetime.utcnow().strftime("%d/%m/%Y %H:%M")
report = f"ğŸŒŠ <b>PÃŠCHEURCONNECT ğŸ‡¸ğŸ‡³ â€“ Rapport mer</b>\nğŸ“… {now} GMT\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n"

alertes = []

# Trier par danger : houle + courant
data_sorted = sorted(data, key=lambda x: (x["houle"], x["courant"]), reverse=True)

for zone in data_sorted:
    houle = zone["houle"]
    courant = zone["courant"]
    
    # DÃ©finir l'alerte
    if houle >= 2.3:
        emoji = "ğŸ”´"
        alert = "ğŸš¨ Danger !"
    elif houle >= 1.4:
        emoji = "ğŸŸ¡"
        alert = "âš ï¸ Prudence"
    else:
        emoji = "ğŸŸ¢"
        alert = "âœ… Sortie OK"

    report += f"ğŸ“ <b>{zone['zone']}</b> : Houle {houle} m, Courant {courant} km/h â†’ {emoji} {alert}\n"

    # Ajouter aux alertes critiques
    if emoji in ["ğŸ”´", "ğŸŸ¡"]:
        alertes.append(f"{zone['zone']} ({houle} m)")

# Conseils Ã©conomiques (zone eau la plus froide)
best_zone = min(data, key=lambda x: x["sst"])
report += f"\nâ›½ <b>Conseil Ã©conomique :</b> Zone {best_zone['zone']} ({best_zone['sst']}Â°C) â€“ potentiel poisson Ã©levÃ©\n"
report += "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
report += "â„¹ï¸ Restez prudents et suivez les alertes\n"

# Ajouter alertes en tÃªte si existantes
if alertes:
    header = "ğŸš¨ <b>ALERTES MER</b> ğŸš¨\n" + ", ".join(alertes) + "\n\n"
    report = header + report

# Afficher / envoyer
print(report)

# Optionnel : envoi Telegram si tu veux
# import requests
# TG_TOKEN = "TON_TOKEN"
# TG_ID = "TON_CHAT_ID"
# requests.post(
#     f"https://api.telegram.org/bot{TG_TOKEN}/sendMessage",
#     data={"chat_id": TG_ID, "text": report, "parse_mode": "HTML"}
# )
